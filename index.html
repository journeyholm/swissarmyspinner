const removeWinner = () => {
            if (winner && !rapidMode && winner !== "Group Complete!" && !tempWheelItems) {
                 setHiddenNames(prev => [...prev, winner]);
            }
            setWinner(null); setBloomWinner(null); setTempWheelItems(null); setChanceAnim(null); setWinnerTimerActive(false); 
            if(rapidMode) { setRapidMode(false); setRapidWinners([]); }
          };

          const handleImageUpload = (e) => { 
              const f=e.target.files[0]; 
              if(f){ 
                  const r=new FileReader(); 
                  r.onload=(evt)=>{ 
                      const i=new Image(); 
                      i.onload=()=>{
                          setHubImage(i);
                          if(canvasRef.current) drawWheel(canvasRef.current, bloomMode === 'solo' ? activeConcepts : activeNames, rotationRef.current, pointerRef.current, mysteryMode);
                      }; 
                      i.src=evt.target.result; 
                  }; 
                  r.readAsDataURL(f); 
              } 
          };

          const handleStartScoring = (g) => { setActiveTeams(g); setTeamScores(new Array(g.length).fill(0)); setShowGroups(false); };
          const handleUpdateScore = (i,c) => { const n=[...teamScores]; n[i]+=c; setTeamScores(n); if(soundEnabled) playSound('tick', audioCtxRef, soundTheme); };
          const toggleBloomMode = () => { setBattleMode(false); if (bloomMode === 'off') setBloomMode('solo'); else if (bloomMode === 'solo') setBloomMode('dual'); else setBloomMode('off'); };

          const startRapidFire = (count) => {
              if (activeNames.length < count) return;
              const winners = [...activeNames].sort(() => Math.random() - 0.5).slice(0, count);
              setRapidWinners(winners);
              setRapidMode(true);
              setRapidTarget(count);
              spin();
          };

          const runChance = (type) => {
              setWinner(null); setChanceAnim(null);
              if (type === 'num') {
                  const numbers = Array.from({length: 10}, (_, i) => (i + 1).toString());
                  setTempWheelItems(numbers); 
                  setTimeout(() => spin(), 100);
              } else if (type === 'coin') {
                  const result = Math.random() < 0.5 ? "HEADS" : "TAILS";
                  setChanceResult(result); setChanceAnim('coin');
                  if (soundEnabled) playSound('drumroll', audioCtxRef);
                  setTimeout(() => { if(soundEnabled) playSound('win', audioCtxRef); }, 2500);
              } else if (type === 'dice') {
                  setChanceResult(Math.floor(Math.random() * 6) + 1); setChanceAnim('dice');
                  if (soundEnabled) playSound('tick', audioCtxRef);
              }
          };