<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss Army Spinner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* --- ANIMATION KEYFRAMES --- */
        @keyframes slide { 0% { background-position: 0 0; } 100% { background-position: 50px 50px; } }
        @keyframes twinkle { 0% { background-position: 0 0; } 100% { background-position: -100px 50px; } }
        @keyframes pulse { 0% { background-size: 30px 30px; } 50% { background-size: 35px 35px; } 100% { background-size: 30px 30px; } }
        @keyframes scroll { 0% { background-position: 0 0; } 100% { background-position: 0 120px; } }
        @keyframes float { 0% { background-position: 0 0; } 50% { background-position: 20px 20px; } 100% { background-position: 0 0; } }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icons = {
          Settings: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
          Shuffle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>,
          ArrowDown: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
          Volume2: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
          VolumeX: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>,
          Trophy: () => <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
          X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
          UserMinus: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
          Save: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
          Folder: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
          Palette: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10c0 1.28-.75 2.37-1.83 2.92-.71.36-1.17 1.05-1.17 1.83 0 .7.56 1.25 1.25 1.25H20"/></svg>,
          Eye: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
          EyeOff: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
          Trash: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
          Maximize: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect><line x1="12" y1="2" x2="12" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg>,
          Minimize: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>,
          Clock: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
          Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
          Pause: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
          RotateCcw: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
          Bell: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
          HelpCircle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
          Star: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
          Clipboard: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
          History: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
          Users: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
          Copy: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
          Check: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
          Swords: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="M13 19l6-6"/><path d="M16 16l4 4"/><path d="M19 21l2-2"/></svg>,
          Brain: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
          Edit: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
          Refresh: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
          Scales: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
          ThumbsUp: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>,
          ThumbsDown: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>,
          Zap: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
          BarChart: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>,
          Grid: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
          Chair: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 13v-3a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v3"/><path d="M7 13h10"/><path d="M7 13v8"/><path d="M17 13v8"/><path d="M5 21h2"/><path d="M17 21h2"/></svg>,
          Download: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
          Gender: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/></svg>,
          Jar: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 2h-12a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-16a2 2 0 0 0-2-2z"/><line x1="6" y1="2" x2="6" y2="22"/><line x1="18" y1="2" x2="18" y2="22"/><line x1="4" y1="6" x2="20" y2="6"/></svg>,
          Circle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/></svg>,
        };

        // --- 2. THEMES & UTILS ---
        const THEMES = {
          default: { 
              colors: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'], 
              bg: "#1e293b", 
              sidebar: "rgba(30, 41, 59, 0.7)", 
              text: "#f1f5f9", 
              accent: "#3b82f6", 
              grad: "linear-gradient(135deg, #0f172a 0%, #1e293b 100%)",
              pattern: "radial-gradient(#334155 1px, transparent 1px)",
              bgSize: "20px 20px", 
              anim: "none"
          },
          chalk: { 
              name: "Chalkboard", 
              colors: ['#ffffff', '#fca5a5', '#fde047', '#86efac', '#93c5fd'], 
              bg: "#1a2e1a", 
              sidebar: "rgba(20, 40, 20, 0.6)", 
              text: "#f0fdf4", 
              accent: "#ffffff",
              grad: "linear-gradient(to bottom, #14532d, #166534)",
              pattern: "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjEiLz48L3N2Zz4=')",
              bgSize: "200px 200px", 
              anim: "none"
          },
          hacker: { 
              name: "The Matrix", 
              colors: ['#00ff00', '#003300', '#00cc00', '#33ff33'], 
              bg: "#000000", 
              sidebar: "rgba(0, 20, 0, 0.8)", 
              text: "#00ff00", 
              accent: "#00ff00",
              grad: "linear-gradient(180deg, #000000 0%, #001100 100%)",
              pattern: "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCI+PHRleHQgeD0iMCIgeT0iMTUiIGZpbGw9IiMwMDMzMDAiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iMTQiPjEwPC90ZXh0Pjx0ZXh0IHg9IjIwIiB5PSIzNSIgZmlsbD0iIzAwMzMwMCIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIxNCI+MDE8L3RleHQ+PHRleHQgeD0iNDAiIHk9IjU1IiBmaWxsPSIjMDAzMzAwIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIiBmb250LXNpemU9IjE0Ij4xMTwvdGV4dD48L3N2Zz4=')",
              bgSize: "60px 60px", 
              anim: "scroll"
          },
          ocean: { 
              name: "Deep Ocean", 
              colors: ['#22d3ee', '#38bdf8', '#60a5fa', '#818cf8', '#c084fc'], 
              bg: "#082f49", 
              sidebar: "rgba(8, 47, 73, 0.6)", 
              text: "#f0f9ff", 
              accent: "#38bdf8",
              grad: "linear-gradient(to bottom, #0c4a6e, #075985)",
              pattern: "radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px)",
              bgSize: "40px 40px",
              anim: "float"
          },
          modern: { 
              name: "Neon City", 
              colors: ['#F472B6', '#38BDF8', '#A78BFA', '#34D399', '#FBBF24'], 
              bg: "#0f172a", 
              sidebar: "rgba(15, 23, 42, 0.6)", 
              text: "#f8fafc", 
              accent: "#818cf8",
              grad: "linear-gradient(180deg, #0f172a 0%, #1e1b4b 100%)",
              pattern: "linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px)",
              bgSize: "40px 40px",
              anim: "slide"
          },
          space: { 
              name: "Deep Space", 
              colors: ['#6366f1', '#a855f7', '#ec4899', '#14b8a6'], 
              bg: "#000000", 
              sidebar: "rgba(20, 20, 30, 0.6)", 
              text: "#ffffff", 
              accent: "#c084fc",
              grad: "radial-gradient(circle at center, #1e1b4b 0%, #000000 100%)",
              pattern: "radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px), radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px)",
              bgSize: "550px 550px", 
              anim: "twinkle"
          },
          lofi: { 
              name: "Lofi CafÃ©", 
              colors: ['#D4A373', '#FAEDCD', '#CCD5AE', '#E9EDC9', '#FEFAE0'], 
              bg: "#2c1a16", 
              sidebar: "rgba(60, 40, 30, 0.6)", 
              text: "#FEFAE0", 
              accent: "#D4A373",
              grad: "linear-gradient(to bottom, #3E2723, #271c19)",
              pattern: "repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 10px)",
              bgSize: "20px 20px", 
              anim: "none"
          },
          candy: { 
              name: "Cotton Candy", 
              colors: ['#ffb7b2', '#ffdac1', '#e2f0cb', '#b5ead7', '#c7ceea'], 
              bg: "#fff1f2", 
              sidebar: "rgba(255, 255, 255, 0.5)", 
              text: "#831843", 
              accent: "#db2777",
              grad: "linear-gradient(120deg, #fff1f2 0%, #fff7ed 100%)",
              pattern: "radial-gradient(circle, rgba(244, 114, 182, 0.1) 10%, transparent 10%)",
              bgSize: "30px 30px",
              anim: "slide"
          }
        };

        const playSound = (type, audioCtxRef, theme = 'standard') => {
          try {
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (!AudioContextClass) return;
            if (!audioCtxRef.current) audioCtxRef.current = new AudioContextClass();
            if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume().catch(() => {});
            const ctx = audioCtxRef.current;
            
            // --- MARBLE FX ---
            if (type === 'clink') {
                 const o = ctx.createOscillator();
                 const g = ctx.createGain();
                 o.connect(g); g.connect(ctx.destination);
                 o.type = 'sine'; 
                 o.frequency.setValueAtTime(2000 + Math.random()*500, ctx.currentTime); 
                 g.gain.setValueAtTime(0, ctx.currentTime);
                 g.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.01);
                 g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
                 o.start(); o.stop(ctx.currentTime + 0.1);
                 return;
            }

            // --- GAME SHOW FX ---
            if (type === 'correct') {
                 const o = ctx.createOscillator();
                 const g = ctx.createGain();
                 o.connect(g); g.connect(ctx.destination);
                 o.type = 'sine'; o.frequency.setValueAtTime(600, ctx.currentTime);
                 o.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                 g.gain.setValueAtTime(0, ctx.currentTime);
                 g.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.05); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                 o.start(); o.stop(ctx.currentTime + 0.5);
                 setTimeout(() => {
                     const o2 = ctx.createOscillator(); const g2 = ctx.createGain();
                     o2.connect(g2); g2.connect(ctx.destination);
                     o2.type = 'triangle'; o2.frequency.setValueAtTime(1200, ctx.currentTime);
                     g2.gain.setValueAtTime(0.2, ctx.currentTime); 
                     g2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                     o2.start(); o2.stop(ctx.currentTime + 0.5);
                 }, 100);
                 return;
            }
            if (type === 'wrong') {
                 const o = ctx.createOscillator();
                 const g = ctx.createGain();
                 o.connect(g); g.connect(ctx.destination);
                 o.type = 'sawtooth'; o.frequency.setValueAtTime(150, ctx.currentTime);
                 o.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                 g.gain.setValueAtTime(0.2, ctx.currentTime);
                 g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
                 o.start(); o.stop(ctx.currentTime + 0.4);
                 return;
            }
            if (type === 'drumroll') {
                 const o = ctx.createOscillator();
                 const g = ctx.createGain();
                 o.connect(g); g.connect(ctx.destination);
                 o.type = 'square'; o.frequency.setValueAtTime(50, ctx.currentTime);
                 g.gain.setValueAtTime(0.05, ctx.currentTime); 
                 o.start(); o.stop(ctx.currentTime + 1.0);
                 return;
            }

            // --- STANDARD THEMES ---
            if (theme === 'standard') {
                if (type === 'tick') {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(600, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.05);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                    osc.start(); osc.stop(ctx.currentTime + 0.06);
                } else if (type === 'win') {
                    [440, 554, 659, 880].forEach((freq, i) => {
                        const o = ctx.createOscillator(); const g = ctx.createGain();
                        o.type = 'square'; o.frequency.value = freq;
                        o.connect(g); g.connect(ctx.destination);
                        g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.05);
                        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.0);
                        o.start(ctx.currentTime + i * 0.1); o.stop(ctx.currentTime + 1.5);
                    });
                }
            } else if (theme === 'arcade') {
                if (type === 'tick') {
                     const o = ctx.createOscillator();
                     const g = ctx.createGain();
                     o.type = 'square'; o.frequency.setValueAtTime(200, ctx.currentTime);
                     o.connect(g); g.connect(ctx.destination);
                     g.gain.setValueAtTime(0.1, ctx.currentTime); g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.03);
                     o.start();
                     o.stop(ctx.currentTime + 0.03);
                } else if (type === 'win') {
                     [523, 659, 784, 1046, 784, 1046].forEach((f, i) => {
                         const o = ctx.createOscillator(); const g = ctx.createGain();
                         o.type = 'sawtooth'; o.frequency.value = f;
                         o.connect(g); g.connect(ctx.destination);
                         g.gain.setValueAtTime(0.1, ctx.currentTime + i * 0.1); g.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.1 + 0.1);
                         o.start(ctx.currentTime + i * 0.1); o.stop(ctx.currentTime + i * 0.1 + 0.1);
                     });
                }
            } else if (theme === 'spooky') {
                if (type === 'tick') {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sine'; o.frequency.setValueAtTime(100, ctx.currentTime); o.frequency.linearRampToValueAtTime(50, ctx.currentTime + 0.1);
                    o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.3, ctx.currentTime);
                    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
                    o.start(); o.stop(ctx.currentTime + 0.1);
                } else if (type === 'win') {
                     const o = ctx.createOscillator();
                     const g = ctx.createGain();
                     o.type = 'sine'; o.frequency.setValueAtTime(300, ctx.currentTime); o.frequency.linearRampToValueAtTime(600, ctx.currentTime + 1); o.frequency.linearRampToValueAtTime(200, ctx.currentTime + 2);
                     o.connect(g); g.connect(ctx.destination);
                     g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.5); g.gain.linearRampToValueAtTime(0, ctx.currentTime + 2.5);
                     o.start(); o.stop(ctx.currentTime + 2.5);
                }
            }
            if (type === 'bell') {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.connect(gain); gain.connect(ctx.destination);
              osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, ctx.currentTime);
              gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.0);
              osc.start();
              osc.stop(ctx.currentTime + 2.0);
            }
          } catch (e) { console.warn("Audio play failed", e);
          }
        };

        const FireConfetti = (canvas) => {
          if (!canvas) return;
          const ctx = canvas.getContext('2d'); if (!ctx) return;
          canvas.width = window.innerWidth; canvas.height = window.innerHeight;
          let particles = [];
          const colors = ['#ef4444', '#eab308', '#3b82f6', '#22c55e'];
          for (let i=0; i<200; i++) particles.push({x:canvas.width/2,y:canvas.height/2,vx:(Math.random()-0.5)*25,vy:(Math.random()-0.5)*25,size:Math.random()*12+6,color:colors[Math.floor(Math.random()*colors.length)],life:120,decay:Math.random()*0.04+0.01});
          const animate = () => { ctx.clearRect(0,0,canvas.width,canvas.height);
          let active = false; particles.forEach(p=>{ if(p.life>0){ active=true; p.x+=p.vx; p.y+=p.vy; p.vy+=0.4; p.life-=1; p.size*=0.95; ctx.fillStyle=p.color; ctx.globalAlpha=Math.min(p.life/20,1); ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); } });
          if(active) requestAnimationFrame(animate); else ctx.clearRect(0,0,canvas.width,canvas.height); };
          animate();
        };

        const defaultNames = ["Welcome", "to", "Leveled", "Up", "Learning!"];
        const defaultConcepts = ["Remember", "Understand", "Apply", "Analyze", "Evaluate", "Create"];

        // --- 3. SUB-COMPONENTS ---
const DraggableBox = ({ children, x=20, y=70, style={}, className="" }) => {
    const [pos, setPos] = useState({x, y});
    const [dragging, setDragging] = useState(false);
    const offset = useRef({x:0, y:0});

    useEffect(() => {
const move = (e) => {
                    if(!dragging) return;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    // Keeps widgets 100px away from the edges so they stay grabable
                    const newX = Math.max(10, Math.min(clientX - offset.current.x, window.innerWidth - 110));
                    const newY = Math.max(10, Math.min(clientY - offset.current.y, window.innerHeight - 110));
                    
                    setPos({ x: newX, y: newY });
                };
        const up = () => setDragging(false);
        if(dragging) {
            window.addEventListener('pointermove', move);
            window.addEventListener('pointerup', up);
        }
        return () => {
            window.removeEventListener('pointermove', move);
            window.removeEventListener('pointerup', up);
        };
    }, [dragging]);

    const start = (e) => {
        // Don't drag if clicking interactive elements inside the widget
        if(['BUTTON', 'SELECT', 'OPTION', 'INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        setDragging(true);
        offset.current = { x: clientX - pos.x, y: clientY - pos.y };
    };

    return (
        <div onPointerDown={start} style={{...style, position:'absolute', left:pos.x, top:pos.y, cursor: dragging ? 'grabbing' : 'grab', userSelect:'none', touchAction:'none'}} className={className}>
            {children}
        </div>
    );
};

        const Timer = ({ audioCtx, onClose }) => {
          const [mode, setMode] = useState('stopwatch');
          const [time, setTime] = useState(0); 
          const [isRunning, setIsRunning] = useState(false); const [initialTime, setInitialTime] = useState(0);
          const [viewMode, setViewMode] = useState('window'); // 'window', 'fullscreen', 'mini'
          const timeOptions = [{label:'10s',val:10},{label:'30s',val:30},{label:'1m',val:60},{label:'2m',val:120},{label:'5m',val:300},{label:'10m',val:600},{label:'20m',val:1200},{label:'30m',val:1800},{label:'45m',val:2700},{label:'1h',val:3600}];
          
          useEffect(() => {
            let interval;
            if (isRunning) { interval = setInterval(() => { setTime(prev => { if (mode === 'timer') { if (prev <= 1) { playSound('bell', audioCtx); setIsRunning(false); return 0; } return prev - 1; } return prev + 1; }); }, 1000); }
            return () => clearInterval(interval);
          }, [isRunning, mode, audioCtx]);
          
          const formatTime = (s) => { const mins = Math.floor(s/60); const secs = s%60; return mins>=60?`${Math.floor(mins/60)}:${(mins%60).toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`:`${mins}:${secs.toString().padStart(2,'0')}`; };
          const handleSelectTime = (e) => { const seconds = parseInt(e.target.value); if (!isNaN(seconds)) { setMode('timer'); setInitialTime(seconds); setTime(seconds); setIsRunning(false); } };
          const handleReset = () => { setIsRunning(false); setTime(mode === 'timer' ? initialTime : 0); };

          if (viewMode === 'fullscreen') {
              return (
                  <div style={{position:'fixed', inset:0, zIndex:100, background:'rgba(15,23,42,0.95)', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center'}}>
                      <div style={{fontSize:'25vw', fontWeight:900, fontFamily:'monospace', fontVariantNumeric:'tabular-nums', lineHeight:1, color: time<=10 && mode==='timer' && time>0 ? '#ef4444' : '#fff'}}>
                          {formatTime(time)}
                      </div>
                      <div style={{display:'flex', gap:20, marginTop:20}}>
                          <button onClick={()=>setIsRunning(!isRunning)} className="btn" style={{background: isRunning?'#ef4444':'#22c55e', fontSize:'2rem', padding:'15px 40px'}}>{isRunning ? <Icons.Pause/> : <Icons.Play/>}</button>
                          <button onClick={handleReset} className="btn" style={{background:'rgba(255,255,255,0.1)', fontSize:'2rem', padding:'15px 40px'}}><Icons.RotateCcw/></button>
                          <button onClick={()=>setViewMode('window')} className="btn" style={{background:'rgba(255,255,255,0.1)', fontSize:'2rem', padding:'15px 40px'}}><Icons.Minimize/></button>
                      </div>
                  </div>
              );
          }
          if (viewMode === 'mini') {
              return (
                  <DraggableBox x={16} y={70} style={{zIndex:40}}>
                      <div style={{background: isRunning ? (time<=10 && mode==='timer' ? '#ef4444' : '#22c55e') : '#334155', padding:'8px 12px', borderRadius:30, display:'flex', alignItems:'center', gap:10, boxShadow:'0 4px 12px rgba(0,0,0,0.3)', border:'2px solid rgba(255,255,255,0.2)'}}>
                          <span style={{fontWeight:800, fontFamily:'monospace', fontSize:'1.2rem'}}>{formatTime(time)}</span>
                          <button onClick={()=>setIsRunning(!isRunning)} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}>{isRunning ? <Icons.Pause/> : <Icons.Play/>}</button>
                          <button onClick={()=>setViewMode('window')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button>
                      </div>
                  </DraggableBox>
              );
          }
          return (
            <DraggableBox x={16} y={70} style={{zIndex:40}}>
                <div style={{
                    padding:'16px', background:'rgba(15,23,42,0.9)', backdropFilter:'blur(10px)',
                    borderRadius:'16px', border:'1px solid rgba(255,255,255,0.15)',
                    boxShadow:'0 10px 30px rgba(0,0,0,0.4)', display:'flex', flexDirection:'column',
                    gap:'12px', minWidth:'220px'
                }}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                      <div style={{fontSize:'2.5rem',fontWeight:800,fontFamily:'monospace',lineHeight:1,fontVariantNumeric:'tabular-nums',color:time<=10&&mode==='timer'&&time>0?'#ef4444':'#fff'}}>{formatTime(time)}</div>
                      <div style={{display:'flex', gap:4}}>
                          <button onClick={()=>setViewMode('fullscreen')} className="btn" style={{padding:4, background:'transparent'}} title="Fullscreen"><Icons.Maximize/></button>
                          <button onClick={()=>setViewMode('mini')} className="btn" style={{padding:4, background:'transparent'}} title="Minimize"><Icons.Minimize/></button>
                          <button onClick={onClose} style={{background:'none',border:'none',color:'#ef4444',cursor:'pointer',padding:4}}><Icons.X/></button>
                      </div>
                  </div>
                  <select onChange={handleSelectTime} style={{background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.1)',color:'#fff',padding:'8px',borderRadius:'8px',fontSize:'0.9rem',outline:'none',cursor:'pointer',width:'100%'}} defaultValue=""><option value="" disabled>Set Timer...</option>{timeOptions.map((opt,i)=>(<option key={i} value={opt.val} style={{color:'#000'}}>{opt.label}</option>))}</select>
                  <div style={{display:'flex',gap:8}}>
                    <button onClick={()=>setIsRunning(!isRunning)} className="btn" style={{flex:1,background:isRunning?'#ef4444':'#22c55e',color:'white',justifyContent:'center',padding:'10px'}}>{isRunning?"STOP":"START"}</button>
                    <button onClick={handleReset} className="btn" style={{background:'rgba(255,255,255,0.1)',justifyContent:'center',padding:'10px',width:'44px'}}><Icons.RotateCcw/></button>
                  </div>
                </div>
            </DraggableBox>
          );
        };

        const Scoreboard = ({ teams, scores, onUpdateScore, onClose }) => {
          return (
            <div style={{position:'absolute',bottom:0,left:0,right:0,background:'rgba(15,23,42,0.95)',borderTop:'1px solid rgba(255,255,255,0.1)',backdropFilter:'blur(10px)',padding:'16px',zIndex:45,display:'flex',gap:16,overflowX:'auto',alignItems:'center'}}>
                <div style={{display:'flex',alignItems:'center',gap:12,marginRight:'auto'}}><span style={{fontWeight:800,fontSize:'1.2rem',color:'#7c3aed',textTransform:'uppercase',letterSpacing:1}}>Scoreboard</span><button onClick={onClose} className="btn" style={{background:'rgba(255,255,255,0.1)',padding:6}}><Icons.X/></button></div>
                {teams.map((group, i) => (<div key={i} style={{background:'rgba(255,255,255,0.05)',padding:'8px 16px',borderRadius:8,display:'flex',flexDirection:'column',alignItems:'center',minWidth:100,border:'1px solid rgba(255,255,255,0.1)'}}><span style={{fontSize:'0.75rem',opacity:0.7,marginBottom:4}}>Team {i+1}</span><span style={{fontSize:'1.5rem',fontWeight:800,lineHeight:1,marginBottom:8}}>{scores[i]}</span><div style={{display:'flex',gap:4}}><button onClick={()=>onUpdateScore(i,-1)} className="btn" style={{padding:'2px 8px',background:'rgba(239,68,68,0.2)',color:'#f87171',fontSize:'1rem'}}>-</button><button onClick={()=>onUpdateScore(i,1)} className="btn" style={{padding:'2px 8px',background:'rgba(34,197,94,0.2)',color:'#4ade80',fontSize:'1rem'}}>+</button></div></div>))}
            </div>
          );
        };

        const GroupMakerModal = ({ names, onClose, onStartScoring }) => {
            const [groupCount, setGroupCount] = useState(4);
            const [groups, setGroups] = useState([]);
            const [copied, setCopied] = useState(false);
            const [mode, setMode] = useState('list'); // 'list' or 'visual'
            const [isShuffling, setIsShuffling] = useState(false);
            const [selectedStudent, setSelectedStudent] = useState(null); // { name, groupIndex }

            // Initial Generation
            useEffect(() => {
                if (names.length === 0) return;
                const shuffled = [...names].sort(() => Math.random() - 0.5);
                const newGroups = Array.from({ length: groupCount }, () => []);
                shuffled.forEach((name, i) => { newGroups[i % groupCount].push(name); });
                setGroups(newGroups);
            }, [groupCount]);

            const reshuffle = () => {
                setIsShuffling(true);
                let steps = 0;
                const interval = setInterval(() => {
                    const shuffled = [...names].sort(() => Math.random() - 0.5);
                    const newGroups = Array.from({ length: groupCount }, () => []);
                    shuffled.forEach((name, i) => { newGroups[i % groupCount].push(name); });
                    setGroups(newGroups);
                    steps++;
                    if(steps > 8) {
                        clearInterval(interval);
                        setIsShuffling(false);
                    }
                }, 100);
            };

            const copyToClipboard = () => {
                let text = "";
                groups.forEach((group, i) => { text += `Team ${i + 1}:\n` + group.map(m => `- ${m}`).join('\n') + "\n\n"; });
                navigator.clipboard.writeText(text);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            // Visual Mode Handlers
            const handleStudentClick = (name, currentGroupIndex) => {
                if (selectedStudent) {
                    // If clicking same student, deselect
                    if (selectedStudent.name === name) {
                        setSelectedStudent(null);
                    } else {
                        // Swap logic could go here, but simple move is safer for now
                        setSelectedStudent({ name, groupIndex: currentGroupIndex });
                    }
                } else {
                    setSelectedStudent({ name, groupIndex: currentGroupIndex });
                }
            };

            const handleGroupClick = (targetGroupIndex) => {
                if (selectedStudent) {
                    if (selectedStudent.groupIndex === targetGroupIndex) return; // Same group, do nothing

                    // Move student
                    const newGroups = [...groups];
                    // Remove from old
                    newGroups[selectedStudent.groupIndex] = newGroups[selectedStudent.groupIndex].filter(n => n !== selectedStudent.name);
                    // Add to new
                    newGroups[targetGroupIndex].push(selectedStudent.name);
                    
                    setGroups(newGroups);
                    setSelectedStudent(null);
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth: mode === 'visual' ? '95vw' : '800px', width: '100%', height: '85vh', padding: 0, display: 'flex', flexDirection: 'column', background: '#1e293b'}}>
                        
                        {/* Header */}
                        <div style={{padding: 20, background:'rgba(0,0,0,0.2)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <h2 style={{margin:0, fontSize:'1.5rem', fontWeight:800}}>Team Maker</h2>
                            <div style={{display:'flex', gap:10}}>
                                <div style={{background:'rgba(255,255,255,0.1)', borderRadius:8, padding:4, display:'flex'}}>
                                    <button onClick={() => setMode('list')} style={{padding:'6px 12px', borderRadius:6, border:'none', background: mode === 'list' ? '#3b82f6' : 'transparent', color:'white', cursor:'pointer', fontWeight:600}}>List</button>
                                    <button onClick={() => setMode('visual')} style={{padding:'6px 12px', borderRadius:6, border:'none', background: mode === 'visual' ? '#3b82f6' : 'transparent', color:'white', cursor:'pointer', fontWeight:600}}>Visual</button>
                                </div>
                                <button onClick={onClose} className="btn" style={{padding:8}}><Icons.X/></button>
                            </div>
                        </div>

                        {/* Controls */}
                        <div style={{padding: 20, borderBottom:'1px solid rgba(255,255,255,0.1)', display:'flex', gap:15, alignItems:'center', flexWrap:'wrap'}}>
                            <div style={{display:'flex', alignItems:'center', gap:8}}>
                                <span style={{fontWeight:600}}>Count:</span>
                                <select value={groupCount} onChange={(e)=>setGroupCount(parseInt(e.target.value))} style={{padding:'8px', borderRadius:6, border:'1px solid rgba(255,255,255,0.2)', background:'rgba(0,0,0,0.3)', color:'white', fontWeight:700, cursor:'pointer'}}>
                                    {[2,3,4,5,6,7,8,9,10,11,12].map(num=>(<option key={num} value={num}>{num} Teams</option>))}
                                </select>
                            </div>
                            <button onClick={reshuffle} className="btn" disabled={isShuffling} style={{background:'rgba(16, 185, 129, 0.2)', color:'#10b981'}}><Icons.Shuffle/> {isShuffling ? 'Mixing...' : 'Reshuffle'}</button>
                            {mode === 'list' && <button onClick={copyToClipboard} className="btn" style={{background:'rgba(255,255,255,0.1)'}}>{copied?<><Icons.Check/> Copied!</>:<><Icons.Copy/> Copy Text</>}</button>}
                            <div style={{flex:1}}></div>
                            <button onClick={()=>onStartScoring(groups)} className="btn" style={{background:'#7c3aed', color:'white', padding:'10px 20px'}}><Icons.Trophy/> Start Scoring</button>
                        </div>

                        {/* Content Area */}
                        <div style={{flex:1, overflowY:'auto', padding:20, background: mode === 'visual' ? '#334155' : 'transparent', position:'relative'}}>
                            
                            {mode === 'visual' && (
                                <div style={{position:'absolute', top:20, left:0, width:'100%', textAlign:'center', pointerEvents:'none', opacity:0.5, fontSize:'0.9rem'}}>
                                    {selectedStudent ? `Tap a table to move ${selectedStudent.name}` : "Tap a student to move them"}
                                </div>
                            )}

                            {mode === 'list' ? (
                                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(200px, 1fr))', gap:15}}>
                                    {groups.map((group, i) => (
                                        <div key={i} style={{background:'rgba(255,255,255,0.05)', borderRadius:12, padding:15, border:'1px solid rgba(255,255,255,0.1)'}}>
                                            <div style={{fontWeight:800, color:'#a78bfa', marginBottom:10, textTransform:'uppercase', fontSize:'0.8rem', letterSpacing:1}}>Team {i+1}</div>
                                            {group.map((member, j) => (
                                                <div key={j} style={{padding:'4px 0', borderBottom:'1px solid rgba(255,255,255,0.05)', fontSize:'0.95rem'}}>{member}</div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div style={{display:'flex', flexWrap:'wrap', gap:30, justifyContent:'center', paddingBottom:50, marginTop: 30}}>
                                    {groups.map((group, i) => (
                                        <div 
                                            key={i} 
                                            onClick={() => handleGroupClick(i)}
                                            style={{
                                                width: 260, minHeight: 180, background:'#1e293b', borderRadius:20, 
                                                border: selectedStudent && selectedStudent.groupIndex !== i ? '2px dashed #4ade80' : '2px solid rgba(255,255,255,0.1)',
                                                boxShadow: '0 10px 30px rgba(0,0,0,0.3)',
                                                display:'flex', flexDirection:'column', alignItems:'center', padding:15,
                                                cursor: selectedStudent && selectedStudent.groupIndex !== i ? 'pointer' : 'default',
                                                transition: 'all 0.2s'
                                            }}
                                        >
                                            <div style={{width:'100%', textAlign:'center', fontWeight:800, color:'#94a3b8', marginBottom:15, textTransform:'uppercase', fontSize:'0.8rem', letterSpacing:1}}>Table {i+1}</div>
                                            
                                            {/* Table Graphic */}
                                            <div style={{width: 140, height: 60, background:'rgba(255,255,255,0.1)', borderRadius:8, marginBottom:20, display:'flex', alignItems:'center', justifyContent:'center', fontSize:'2rem'}}>ðŸª‘</div>

                                            <div style={{display:'flex', flexWrap:'wrap', gap:8, justifyContent:'center'}}>
                                                {group.map((member, j) => (
                                                    <div 
                                                        key={j}
                                                        onClick={(e) => { e.stopPropagation(); handleStudentClick(member, i); }}
                                                        style={{
                                                            padding:'6px 12px', borderRadius:20, fontSize:'0.85rem', fontWeight:600,
                                                            background: selectedStudent?.name === member ? '#3b82f6' : 'rgba(255,255,255,0.1)',
                                                            color: 'white', cursor:'pointer', border:'1px solid rgba(255,255,255,0.1)',
                                                            transform: selectedStudent?.name === member ? 'scale(1.1)' : 'scale(1)',
                                                            boxShadow: selectedStudent?.name === member ? '0 4px 12px rgba(59, 130, 246, 0.5)' : 'none',
                                                            transition: 'all 0.2s'
                                                        }}
                                                    >
                                                        {member}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

const HelpModal = ({ onClose }) => {
            const [activeTab, setActiveTab] = useState('start');
            const tabs = [
                { id: 'start', label: 'ðŸš€ Start', color: '#3b82f6' },
                { id: 'spin', label: 'ðŸŽ¡ Spin', color: '#8b5cf6' },
                { id: 'manage', label: 'ðŸ« Manage', color: '#10b981' },
                { id: 'tools', label: 'âš¡ Tools', color: '#f59e0b' }
            ];

            return (
                <div className="modal-overlay">
                  <div className="modal" style={{maxWidth:750, padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column', height: '85vh', background: '#0f172a', textAlign: 'left'}}>
                     <div style={{padding: '20px 30px', background: 'rgba(255,255,255,0.03)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                        <h2 style={{margin:0, fontSize:'1.4rem', fontWeight:900}}>Teacher Quick-Start Guide</h2>
                        <button onClick={onClose} className="btn" style={{padding:6, border:'none', background:'rgba(239,68,68,0.1)', color:'#ef4444'}}><Icons.X/></button>
                     </div>
                     <div style={{display:'flex', gap: 8, padding: '12px 20px', background: 'rgba(0,0,0,0.2)'}}>
                        {tabs.map(t => (
                            <div key={t.id} onClick={()=>setActiveTab(t.id)} style={{
                                flex: 1, textAlign: 'center', padding: '10px', borderRadius: '10px', cursor: 'pointer', fontWeight: 800, fontSize: '0.75rem',
                                background: activeTab === t.id ? `${t.color}33` : 'transparent',
                                color: activeTab === t.id ? t.color : 'rgba(255,255,255,0.4)',
                                border: activeTab === t.id ? `1px solid ${t.color}` : '1px solid transparent'
                            }}>{t.label}</div>
                        ))}
                     </div>
                     <div style={{flex: 1, overflowY:'auto', padding: '30px'}}>
                        {activeTab === 'start' && (
                            <div style={{animation: 'fadeIn 0.3s'}}>
                                <h3 style={{color: '#3b82f6', marginTop: 0}}>ðŸš€ Get Running in 3 Steps</h3>
                                <p><b>1. Add Names:</b> Paste your student list into the text area. Tap a name chip to temporarily hide a student.</p>
                                <p><b>2. Save Session:</b> Click the <b>Save</b> icon. This remembers names, participation counts, and marble progress.</p>
                                <p><b>3. Present:</b> Close the settings or use <b>Projector Mode</b> to maximize the wheel for your students.</p>
                            </div>
                        )}
                        {activeTab === 'spin' && (
                            <div style={{animation: 'fadeIn 0.3s'}}>
                                <h3 style={{color: '#8b5cf6', marginTop: 0}}>ðŸŽ¡ Spin Mode Breakdown</h3>
                                <p>â€¢ <b>Concept Mode:</b> Spins a Name + a Task (like Bloom's Taxonomy) at once.</p>
                                <p>â€¢ <b>Fair Mode:</b> Winners are removed so everyone gets a turn.</p>
                                <p>â€¢ <b>Mystery Mode:</b> Hides labels while spinning for maximum suspense.</p>
                                <p>â€¢ <b>Battle Mode:</b> Selects two random "Contestants" for head-to-head challenges.</p>
                            </div>
                        )}
                        {activeTab === 'manage' && (
                            <div style={{animation: 'fadeIn 0.3s'}}>
                                <h3 style={{color: '#10b981', marginTop: 0}}>ðŸ« Classroom Management</h3>
                                <p>â€¢ <b>Marble Jar:</b> Set behavior goals. Click <b>+Drop</b> to celebrate class wins with physics-based marbles!</p>
                                <p>â€¢ <b>Seating Chart:</b> Drag seats into your floor plan. Use <b>Architect</b> to build and <b>Students</b> to assign names.</p>
                                <p>â€¢ <b>Heatmap:</b> Click the <b>Bar Chart</b> icon to see participation and export data for your gradebook.</p>
                            </div>
                        )}
                        {activeTab === 'tools' && (
                            <div style={{animation: 'fadeIn 0.3s'}}>
                                <h3 style={{color: '#f59e0b', marginTop: 0}}>âš¡ Essential Teacher Tools</h3>
                                <p>â€¢ <b>Noise Meter:</b> Real-time visual feedback on classroom volume.</p>
                                <p>â€¢ <b>Billboard:</b> Project giant text or a QR code link for students to scan.</p>
                                <p>â€¢ <b>Strategy Spin:</b> Randomly select one of 25+ Kagan engagement strategies.</p>
                                <div style={{marginTop: 20, padding: 15, background: 'rgba(255, 255, 255, 0.05)', borderRadius: 12, fontSize: '0.85rem'}}>
                                    ðŸ“± <b>Mobile Tips:</b> Grab window title bars to drag tools. The wheel auto-shrinks to make space for the Timer!
                                </div>
                            </div>
                        )}
                     </div>
                     <div style={{padding: '20px 30px', background: 'rgba(0,0,0,0.2)', textAlign: 'center'}}>
                        <button onClick={onClose} className="btn btn-primary" style={{width:'100%', fontSize:'1.1rem', padding:16, borderRadius: '16px'}}>I'm Ready to Teach!</button>
                     </div>
                  </div>
                </div>
            );
        };

        const ImportModal = ({ onClose, onImport }) => {
            const [text, setText] = useState("");
            const fileInputRef = useRef(null);
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.onload = (event) => { setText(event.target.result); }; reader.readAsText(file); };
            const handleImport = () => { if (!text.trim()) return; const splitNames = text.split(/[\n,;]+/).map(n => n.trim()).filter(n => n.length > 0);
            if (splitNames.length > 0) onImport(splitNames); };
            return (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth:500,textAlign:'left'}}>
                         <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h2 style={{margin:0,fontSize:'1.5rem'}}>Import List</h2><button onClick={onClose} className="btn" style={{padding:4}}><Icons.X/></button></div>
                         <p style={{fontSize:'0.9rem',opacity:0.8,marginBottom:12}}>Paste your list or upload a <b>.csv/.txt</b> file.</p>
                         <div style={{marginBottom:16}}><input type="file" accept=".csv,.txt,.text" ref={fileInputRef} style={{display:'none'}} onChange={handleFileUpload}/><button onClick={() => fileInputRef.current.click()} className="btn" style={{width:'100%',justifyContent:'center',background:'rgba(128,128,128,0.1)',border:'1px dashed rgba(128,128,128,0.4)'}}><Icons.Folder /> Choose File</button></div>
                         <textarea value={text} onChange={(e)=>setText(e.target.value)} className="textarea" placeholder="Paste names..." style={{minHeight:200,marginBottom:20}}/>
                         <div style={{display:'flex',gap:12,justifyContent:'flex-end'}}><button onClick={onClose} className="btn" style={{background:'rgba(128,128,128,0.2)'}}>Cancel</button><button onClick={handleImport} className="btn" style={{background:'#7c3aed',color:'white'}}>Import</button></div>
                    </div>
                </div>
            );
        };

        const ConceptModal = ({ concepts, onClose, onSave }) => {
            const [text, setText] = useState(concepts.join('\n'));
            const handleSave = () => {
                const split = text.split(/[\n,;]+/).map(n => n.trim()).filter(n => n.length > 0);
                if (split.length > 0) onSave(split);
                onClose();
            };
            return (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth:500,textAlign:'left'}}>
                         <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h2 style={{margin:0,fontSize:'1.5rem'}}>Edit Concepts</h2><button onClick={onClose} className="btn" style={{padding:4}}><Icons.X/></button></div>
                         <p style={{fontSize:'0.9rem',opacity:0.8,marginBottom:12}}>Enter items for the 2nd wheel (e.g., questions, prizes, or taxonomy levels).</p>
                         <textarea value={text} onChange={(e)=>setText(e.target.value)} className="textarea" placeholder="Item 1&#10;Item 2..." style={{minHeight:200,marginBottom:20}}/>
                         <div style={{display:'flex',gap:12,justifyContent:'flex-end'}}><button onClick={onClose} className="btn" style={{background:'rgba(128,128,128,0.2)'}}>Cancel</button><button onClick={handleSave} className="btn" style={{background:'#7c3aed',color:'white'}}>Save Changes</button></div>
                    </div>
                </div>
            );
        };

        const WinnerTimer = ({ duration, onComplete }) => {
            const [timeLeft, setTimeLeft] = useState(duration);
            useEffect(() => {
                if (timeLeft <= 0) { onComplete(); return; }
                const interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                return () => clearInterval(interval);
            }, [timeLeft, onComplete]);
            return (
                <div style={{fontSize: '1.2rem', fontWeight: 800, color: timeLeft <= 5 ? '#ef4444' : '#fbbf24', marginTop: 8}}>
                    {timeLeft}s
                </div>
            );
        };

        // --- UPGRADED SEATING CHART (With Drag & Sub-Tools) ---
        const SeatingChart = ({ names, onClose }) => {
            const [mode, setMode] = useState('architect'); // 'architect' (build) or 'assign' (place students)
            const [architectTool, setArchitectTool] = useState('move'); // 'move', 'add', 'delete'
            const [seats, setSeats] = useState([]);
            const [studentData, setStudentData] = useState(names.map(n => ({ id: n, name: n, tag: 'A', assigned: null })));
            const [selectedStudent, setSelectedStudent] = useState(null);
            
            // DRAG STATE
            const [dragState, setDragState] = useState(null); // { id, offsetX, offsetY }
            const containerRef = useRef(null);

            // --- DRAG HANDLERS (iPad/Mouse) ---
            const handlePointerDown = (e, seatId) => {
                if (mode === 'architect' && architectTool === 'move') {
                    e.stopPropagation(); // Stop click from hitting background
                    e.preventDefault();  // Stop scrolling on touch
                    const seat = seats.find(s => s.id === seatId);
                    // Calculate where we grabbed the seat relative to its top-left corner
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    setDragState({
                        id: seatId,
                        offsetX: clientX - seat.x,
                        offsetY: clientY - seat.y
                    });
                } else if (mode === 'architect' && architectTool === 'delete') {
                    e.stopPropagation();
                    removeSeat(seatId);
                } else if (mode === 'assign') {
                    e.stopPropagation();
                    handleAssignClick(seatId);
                }
            };

            const handlePointerMove = (e) => {
                if (dragState) {
                    e.preventDefault();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    // Update Seat Position
                    setSeats(prev => prev.map(s => 
                        s.id === dragState.id 
                        ? { ...s, x: clientX - dragState.offsetX, y: clientY - dragState.offsetY } 
                        : s
                    ));
                }
            };

            const handlePointerUp = () => {
                setDragState(null);
            };

            // ARCHITECT TOOLS
            const handleBackgroundClick = (e) => {
                if (mode === 'architect' && architectTool === 'add') {
                    const rect = e.currentTarget.getBoundingClientRect();
                    // Add seat centered on click
                    const id = Date.now();
                    setSeats([...seats, { id, x: e.clientX - rect.left - 30, y: e.clientY - rect.top - 30 }]);
                }
            };

            const removeSeat = (id) => {
                setSeats(seats.filter(s => s.id !== id));
                setStudentData(prev => prev.map(s => s.assigned === id ? { ...s, assigned: null } : s));
            };
            
            // AUTO LAYOUTS
            const generateLayout = (type) => {
                const newSeats = [];
                const rows = Math.ceil(Math.sqrt(names.length));
                const cols = Math.ceil(names.length / rows);
                
                if (type === 'grid') {
                    for(let r=0; r<rows; r++) {
                        for(let c=0; c<cols; c++) {
                            newSeats.push({ id: `s-${r}-${c}`, x: c * 80 + 50, y: r * 80 + 50 });
                        }
                    }
                } else if (type === 'pairs') {
                    for(let i=0; i<names.length; i++) {
                        const row = Math.floor(i / 6);
                        const col = i % 6;
                        const gap = col % 2 === 0 ? 0 : 20; 
                        newSeats.push({ id: `p-${i}`, x: (col * 70) + gap + 50, y: row * 80 + 50 });
                    }
                } else if (type === 'groups') {
                    const groupSize = 4;
                    const groupCount = Math.ceil(names.length / groupSize);
                    for(let g=0; g<groupCount; g++) {
                        const gx = (g % 3) * 200 + 100;
                        const gy = Math.floor(g / 3) * 200 + 100;
                        newSeats.push({ id: `g-${g}-a`, x: gx, y: gy });
                        newSeats.push({ id: `g-${g}-b`, x: gx+60, y: gy });
                        newSeats.push({ id: `g-${g}-c`, x: gx, y: gy+60 });
                        newSeats.push({ id: `g-${g}-d`, x: gx+60, y: gy+60 });
                    }
                }
                setSeats(newSeats);
            };

            // ASSIGNMENT TOOLS
            const toggleTag = (studentId) => {
                setStudentData(prev => prev.map(s => s.id === studentId ? { ...s, tag: s.tag === 'A' ? 'B' : 'A' } : s));
            };

            const randomFill = (balanced = false) => {
                let currentStudents = [...studentData].map(s => ({...s, assigned: null}));
                let availableSeats = [...seats];
                
                if (balanced) {
                    // Balance A/B (Boy/Girl)
                    const groupA = currentStudents.filter(s => s.tag === 'A').sort(() => Math.random() - 0.5);
                    const groupB = currentStudents.filter(s => s.tag === 'B').sort(() => Math.random() - 0.5);
                    availableSeats.forEach((seat, i) => {
                        if (i % 2 === 0 && groupA.length > 0) currentStudents.find(s => s.id === groupA.pop().id).assigned = seat.id;
                        else if (groupB.length > 0) currentStudents.find(s => s.id === groupB.pop().id).assigned = seat.id;
                        else if (groupA.length > 0) currentStudents.find(s => s.id === groupA.pop().id).assigned = seat.id; 
                    });
                } else {
                    const shuffled = currentStudents.sort(() => Math.random() - 0.5);
                    availableSeats.forEach((seat, i) => {
                        if (shuffled[i]) shuffled[i].assigned = seat.id;
                    });
                }
                setStudentData(currentStudents);
            };

            const handleAssignClick = (seatId) => {
                if (selectedStudent) {
                    setStudentData(prev => prev.map(s => {
                        if (s.assigned === seatId) return { ...s, assigned: null }; // Bump existing
                        if (s.id === selectedStudent) return { ...s, assigned: seatId }; // Place new
                        return s;
                    }));
                    setSelectedStudent(null);
                } else {
                    // Pick up student from seat
                    const occupant = studentData.find(s => s.assigned === seatId);
                    if (occupant) setSelectedStudent(occupant.id);
                }
            };

            const downloadChart = () => {
                const element = document.getElementById('seating-area');
                if(!element) return;
                html2canvas(element).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'seating-chart.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };

            return (
                <div className="modal-overlay" style={{alignItems: 'flex-start', paddingTop: 20}} 
                     onPointerMove={handlePointerMove} onPointerUp={handlePointerUp} onTouchMove={handlePointerMove} onTouchEnd={handlePointerUp}>
                    <div className="modal" style={{maxWidth: '95vw', width: '100%', height: '90vh', padding: 0, display: 'flex', flexDirection: 'column', background:'#1e293b'}}>
                        
                        {/* HEADER TOOLBAR */}
                        <div style={{padding: 15, background: 'rgba(0,0,0,0.2)', borderBottom: '1px solid rgba(255,255,255,0.1)', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div style={{display:'flex', gap: 10}}>
                                <button onClick={() => setMode('architect')} className="btn" style={{background: mode === 'architect' ? '#3b82f6' : 'rgba(255,255,255,0.1)'}}><Icons.Grid/> Architect</button>
                                <button onClick={() => setMode('assign')} className="btn" style={{background: mode === 'assign' ? '#10b981' : 'rgba(255,255,255,0.1)'}}><Icons.Users/> Students</button>
                            </div>
                            <div style={{display:'flex', gap: 10}}>
                                <button onClick={downloadChart} className="btn" style={{background: 'rgba(255,255,255,0.1)'}}><Icons.Download/> Save Img</button>
                                <button onClick={onClose} className="btn" style={{background: '#ef4444', color:'white'}}><Icons.X/></button>
                            </div>
                        </div>

                        <div style={{flex: 1, display: 'flex', overflow: 'hidden'}}>
                            {/* LEFT SIDEBAR CONTROLS */}
                            <div style={{width: 280, background: 'rgba(0,0,0,0.2)', borderRight: '1px solid rgba(255,255,255,0.1)', padding: 15, overflowY: 'auto'}}>
                                {mode === 'architect' ? (
                                    <div style={{display:'flex', flexDirection:'column', gap: 15}}>
                                        <div className="section-title">Tools</div>
                                        <div style={{display:'flex', gap:5}}>
                                            <button onClick={()=>setArchitectTool('move')} className="btn" style={{flex:1, justifyContent:'center', background: architectTool==='move'?'#3b82f6':'rgba(255,255,255,0.1)'}}>âœ‹ Move</button>
                                            <button onClick={()=>setArchitectTool('add')} className="btn" style={{flex:1, justifyContent:'center', background: architectTool==='add'?'#3b82f6':'rgba(255,255,255,0.1)'}}>âž• Add</button>
                                            <button onClick={()=>setArchitectTool('delete')} className="btn" style={{flex:1, justifyContent:'center', background: architectTool==='delete'?'#ef4444':'rgba(255,255,255,0.1)'}}>ðŸ—‘ï¸ Del</button>
                                        </div>

                                        <div className="section-title">Auto Layouts</div>
                                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap: 8}}>
                                            <button onClick={() => generateLayout('grid')} className="btn" style={{fontSize:'0.8rem', justifyContent:'center'}}>Grid</button>
                                            <button onClick={() => generateLayout('pairs')} className="btn" style={{fontSize:'0.8rem', justifyContent:'center'}}>Pairs</button>
                                            <button onClick={() => generateLayout('groups')} className="btn" style={{fontSize:'0.8rem', justifyContent:'center'}}>Groups</button>
                                            <button onClick={() => setSeats([])} className="btn" style={{fontSize:'0.8rem', justifyContent:'center', color:'#ef4444'}}>Clear</button>
                                        </div>
                                        <div style={{fontSize:'0.8rem', opacity:0.6, marginTop:10}}>
                                            {architectTool === 'move' && "Drag chairs to arrange them."}
                                            {architectTool === 'add' && "Tap anywhere in the room to add a chair."}
                                            {architectTool === 'delete' && "Tap a chair to remove it."}
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{display:'flex', flexDirection:'column', gap: 15}}>
                                        <div className="section-title">Auto Fill</div>
                                        <div style={{display:'flex', gap: 5}}>
                                            <button onClick={() => randomFill(false)} className="btn" style={{flex:1, justifyContent:'center', fontSize:'0.8rem'}}>Random</button>
                                            <button onClick={() => randomFill(true)} className="btn" style={{flex:1, justifyContent:'center', fontSize:'0.8rem'}}>Balanced</button>
                                        </div>
                                        
                                        <div className="section-title">Roster ({studentData.filter(s=>!s.assigned).length} Left)</div>
                                        <div style={{fontSize: '0.75rem', opacity: 0.6, marginBottom: 5}}>Click <Icons.Gender/> to swap Group A/B</div>
                                        
                                        <div style={{display:'flex', flexDirection:'column', gap: 4}}>
                                            {studentData.map(s => (
                                                <div key={s.id} 
                                                    style={{
                                                        display:'flex', alignItems:'center', gap: 8, padding: 8, borderRadius: 6,
                                                        background: selectedStudent === s.id ? '#3b82f6' : (s.assigned ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)'),
                                                        opacity: s.assigned ? 0.5 : 1, cursor: 'pointer'
                                                    }}
                                                >
                                                    <div onClick={() => toggleTag(s.id)} style={{width: 20, height: 20, borderRadius:'50%', background: s.tag === 'A' ? '#60a5fa' : '#f472b6', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'0.6rem', fontWeight:'bold'}}>{s.tag}</div>
                                                    <div onClick={() => setSelectedStudent(selectedStudent === s.id ? null : s.id)} style={{flex: 1, fontWeight: 600}}>{s.name}</div>
                                                    {s.assigned && <Icons.Check style={{width: 12}}/>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* ROOM CANVAS */}
                            <div 
                                id="seating-area"
                                ref={containerRef}
                                onClick={handleBackgroundClick}
                                style={{
                                    flex: 1, position: 'relative', background: '#334155', 
                                    backgroundImage: 'radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px)', 
                                    backgroundSize: '20px 20px',
                                    overflow: 'hidden', 
                                    cursor: architectTool === 'add' ? 'copy' : 'default'
                                }}
                            >
                                <div style={{position:'absolute', top: 10, left: '50%', transform: 'translateX(-50%)', width: 200, height: 40, background: 'rgba(255,255,255,0.1)', borderRadius: 4, display:'flex', alignItems:'center', justifyContent:'center', border: '2px dashed rgba(255,255,255,0.2)', pointerEvents:'none'}}>FRONT OF ROOM</div>

                                {seats.map(seat => {
                                    const occupant = studentData.find(s => s.assigned === seat.id);
                                    return (
                                        <div key={seat.id}
                                            onPointerDown={(e) => handlePointerDown(e, seat.id)}
                                            style={{
                                                position: 'absolute', left: seat.x, top: seat.y,
                                                width: 60, height: 60, borderRadius: 12,
                                                background: occupant ? (occupant.tag === 'A' ? '#60a5fa' : '#f472b6') : (architectTool === 'delete' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(255,255,255,0.1)'),
                                                border: occupant ? '2px solid white' : (architectTool === 'delete' ? '2px solid #ef4444' : '2px dashed rgba(255,255,255,0.3)'),
                                                boxShadow: occupant ? '0 4px 10px rgba(0,0,0,0.3)' : 'none',
                                                display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                                                cursor: mode === 'architect' ? (architectTool === 'move' ? 'grab' : 'pointer') : 'pointer', 
                                                zIndex: dragState?.id === seat.id ? 100 : 10,
                                                touchAction: 'none' // Important for iPad dragging
                                            }}
                                        >
                                            {occupant ? <span style={{fontSize:'0.75rem', fontWeight: 700, lineHeight: 1.1, color:'white', pointerEvents:'none'}}>{occupant.name}</span> : <Icons.Chair style={{opacity: 0.5, pointerEvents:'none'}}/>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

const MarbleJar = ({ audioCtx, names, onClose, marbles, setMarbles, target, setTarget, reward, setReward }) => {
            // --- STATE ---
            const [viewMode, setViewMode] = useState('window'); 
            const [jarSize, setJarSize] = useState('medium'); 
            const [ballSize, setBallSize] = useState('medium');
            const [labelMode, setLabelMode] = useState('number'); 
            const [raffleWinner, setRaffleWinner] = useState(null);
            const [isPlinko, setIsPlinko] = useState(false);
            const [isPhysicsReady, setIsPhysicsReady] = useState(false);
            const [showWinBanner, setShowWinBanner] = useState(false);

            // --- SLOT STATE ---
            const [showSlots, setShowSlots] = useState(false);
            const [slotType, setSlotType] = useState('numbers'); 
            const [customSlotInput, setCustomSlotInput] = useState("A, B, C, D, E");
            const [showSlotEditor, setShowSlotEditor] = useState(false);
            
            // --- REFS ---
            const sceneRef = useRef(null);
            const engineRef = useRef(null);
            const renderRef = useRef(null);
            const runnerRef = useRef(null);
            const jarWrapperRef = useRef(null);

            // --- WIN BANNER LOGIC ---
            useEffect(() => {
                if (marbles >= target && target > 0) {
                    setShowWinBanner(true);
                    const timer = setTimeout(() => setShowWinBanner(false), 3000);
                    return () => clearTimeout(timer);
                } else {
                    setShowWinBanner(false);
                }
            }, [marbles, target]);

            // --- HELPERS ---
            const getSlotLabels = () => {
                switch(slotType) {
                    case 'prizes': return ["ðŸ¬ Candy", "ðŸŽµ DJ", "â­ Star", "ðŸ“ Pass", "ðŸŽ Box"];
                    case 'teams': return ["Red", "Blue", "Green", "Yellow"];
                    case 'multi': return ["x1", "x2", "x5", "x2", "x1"];
                    case 'custom': return customSlotInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    default: return ["1", "2", "3", "4", "5"];
                }
            };

            // --- 1. SETUP PHYSICS ---
            useEffect(() => {
                if (viewMode === 'mini') return;
                
                // Cleanup and restart physics when settings change
                cleanupPhysics();
                const timer = setTimeout(() => { initPhysics(); }, 150);
                
                return () => { clearTimeout(timer); cleanupPhysics(); };
            }, [viewMode, jarSize, isPlinko, showSlots, slotType, customSlotInput]); 

            const cleanupPhysics = () => {
                setIsPhysicsReady(false);
                if (runnerRef.current) Matter.Runner.stop(runnerRef.current);
                if (renderRef.current) {
                    Matter.Render.stop(renderRef.current);
                    if(renderRef.current.canvas) renderRef.current.canvas.remove();
                }
                if (engineRef.current) {
                    Matter.World.clear(engineRef.current.world);
                    Matter.Engine.clear(engineRef.current);
                }
            };

const initPhysics = () => {
                if (typeof Matter === 'undefined') return;

                // 1. MEASURE CONTAINER correctly
                let width = jarWrapperRef.current ? jarWrapperRef.current.clientWidth : 0;
                let height = jarWrapperRef.current ? jarWrapperRef.current.clientHeight : 0;

                if (width < 50 || height < 50) {
                    setTimeout(initPhysics, 50);
                    return;
                }

                const Engine = Matter.Engine;
                const Render = Matter.Render;
                const Runner = Matter.Runner;
                const World = Matter.World;
                const Bodies = Matter.Bodies;

                const engine = Engine.create();
                const render = Render.create({
                    element: sceneRef.current,
                    engine: engine,
                    options: {
                        width: width,
                        height: height,
                        wireframes: false,
                        background: 'transparent',
                        pixelRatio: window.devicePixelRatio || 1
                    }
                });

                // 2. BUILD WALLS
                const wallOpts = { isStatic: true, render: { visible: false } };
                
                // GROUND: Places the floor exactly at the bottom of the widget
                const ground = Bodies.rectangle(width / 2, height - 10, width, 20, wallOpts);
                const leftWall = Bodies.rectangle(-25, height / 2, 50, height * 4, wallOpts);
                const rightWall = Bodies.rectangle(width + 25, height / 2, 50, height * 4, wallOpts);
                
                const funnelAngle = isPlinko ? 0 : Math.PI / 3;
                const slopeOffset = isPlinko ? -200 : -20;
                const leftSlope = Bodies.rectangle(slopeOffset, -50, 200, 20, { isStatic: true, angle: funnelAngle, render: { visible: false } });
                const rightSlope = Bodies.rectangle(width - slopeOffset, -50, 200, 20, { isStatic: true, angle: -funnelAngle, render: { visible: false } });

                const walls = [ground, leftWall, rightWall, leftSlope, rightSlope];

                // 3. PLINKO PEGS
                if (isPlinko) {
                    const pegRadius = 3;
                    const cols = Math.floor(width / 60);
                    const rows = 6;
                    const spacingX = width / (cols + 1);
                    const spacingY = (height * 0.5) / rows;
                    const startY = 60;
                    for (let row = 0; row < rows; row++) {
                        for (let col = 0; col < cols; col++) {
                            const xOffset = row % 2 === 0 ? 0 : spacingX / 2;
                            const x = (col * spacingX) + spacingX/2 + xOffset + 10;
                            const y = startY + (row * spacingY);
                            if (x > 20 && x < width - 20) {
                                walls.push(Bodies.circle(x, y, pegRadius, { isStatic: true, render: { fillStyle: 'rgba(255,255,255,0.4)' } }));
                            }
                        }
                    }
                }

                // 4. SLOTS
                if (showSlots) {
                    const labels = getSlotLabels();
                    const count = labels.length;
                    const slotWidth = width / count;
                    const dividerHeight = 120; 
                    const dividerY = height - (dividerHeight / 2); 

                    for (let i = 1; i < count; i++) {
                        const x = i * slotWidth;
                        walls.push(Bodies.rectangle(x, dividerY, 6, dividerHeight, { 
                            isStatic: true, 
                            render: { fillStyle: 'rgba(255,255,255,0.2)' } 
                        }));
                    }
                }

                World.add(engine.world, walls);

                // 5. RESPAWN MARBLES
                if (marbles > 0) {
                    const balls = [];
                    for(let i=0; i<marbles; i++) {
                        // Dynamic Radius based on container width
                        const baseRadius = Math.min(width, height) * 0.05; 
                        let r = baseRadius; 
                        if (ballSize === 'small') r = baseRadius * 0.7;
                        if (ballSize === 'large') r = baseRadius * 1.3;

                        // Randomize X across 90% of width
                        const safeWidth = width * 0.9;
                        const x = (width * 0.05) + (Math.random() * safeWidth);
                        
                        const y = height - 50 - (i * (r*2));
                        // Create and push
                        balls.push(createMarbleBody(width, false, i+1, x, y, r));
                    }
                    World.add(engine.world, balls);
                }

                // 6. RENDER LOOP
                Matter.Events.on(render, 'afterRender', function() {
                    const context = render.context;
                    
                    // Draw Slot Labels
                    if (showSlots) {
                        const labels = getSlotLabels();
                        const count = labels.length;
                        const slotWidth = width / count;
                        
                        context.textAlign = 'center';
                        context.textBaseline = 'bottom';
                        context.fillStyle = 'rgba(255,255,255,0.9)';
                        const fontSize = Math.min(16, width / (count * 4)); 
                        context.font = `bold ${Math.max(10, fontSize)}px Arial`;

                        labels.forEach((label, i) => {
                            const x = (i * slotWidth) + (slotWidth / 2);
                            const y = height - 10;
                            context.fillText(label, x, y);
                        });
                    }

                    // Draw Marble Labels
                    const bodies = Matter.Composite.allBodies(engine.world);
                    context.textAlign = 'center';
                    context.textBaseline = 'middle';
                    bodies.forEach(body => {
                        if (body.label === 'marble' && body.customLabel) {
                            const { x, y } = body.position;
                            let fontSize = Math.min(body.circleRadius * 1.2, (body.circleRadius * 3.5) / String(body.customLabel).length);
                            if (fontSize < 8) fontSize = 8; 
                            context.save();
                            context.translate(x, y);
                            context.rotate(body.angle);
                            context.fillStyle = body.isGold ? '#78350f' : '#1e293b'; 
                            context.font = `bold ${fontSize}px Arial`;
                            context.fillText(body.customLabel, 0, 0);
                            context.restore();
                        }
                    });
                });

                // Start
                engineRef.current = engine;
                renderRef.current = render;
                runnerRef.current = Runner.create();
                
                Render.run(render);
                Runner.run(runnerRef.current, engine);
                
                setIsPhysicsReady(true); 
            };


            // --- HELPER: Marble Factory ---
            const createMarbleBody = (containerWidth, isGold, num, startX, startY, specificRadius = null) => {
                const plinkoMod = isPlinko ? 0.6 : 1.0;
                let radius = specificRadius;
                if (!radius) {
                    const baseRadius = Math.min(containerWidth, 800) * 0.05; 
                    radius = baseRadius;
                    if (ballSize === 'small') radius = baseRadius * 0.7;
                    if (ballSize === 'large') radius = baseRadius * 1.3;
                }
                radius *= plinkoMod;
                if(isGold) radius *= 1.2;
                radius = Math.max(10, Math.min(radius, 40));

                const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'];
                const rimColor = isGold ? '#b45309' : colors[Math.floor(Math.random() * colors.length)];
                const fillColor = isGold ? '#fcd34d' : '#f8fafc';

                let label = isGold ? "+5" : (labelMode === 'number' ? num.toString() : "?");
                if (labelMode === 'name' && names && names.length > 0 && !isGold) {
                    label = names[Math.floor(Math.random() * names.length)];
                }

                return Matter.Bodies.circle(startX, startY, radius, {
                    restitution: isGold ? 0.4 : 0.6,
                    friction: 0.005,
                    density: isGold ? 0.1 : 0.05,
                    label: 'marble',
                    isGold: isGold,
                    customLabel: label,
                    render: {
                        fillStyle: fillColor,
                        strokeStyle: rimColor,
                        lineWidth: isGold ? 4 : radius * 0.3
                    }
                });
            };


            // --- ACTIONS ---
            const addMarble = () => {
                if (typeof playSound === 'function') playSound('clink', audioCtx);
                if (viewMode === 'mini') { setMarbles(m => m + 1); return; }
                if (!isPhysicsReady || !engineRef.current || !renderRef.current) return;
                
                const w = renderRef.current.options.width;
                const safeWidth = w * 0.9;
                const x = (w * 0.05) + (Math.random() * safeWidth);
                
                const ball = createMarbleBody(w, false, marbles + 1, x, -50);
                
                Matter.World.add(engineRef.current.world, ball);
                setMarbles(m => m + 1);
                checkWin(marbles + 1);
            };

            const addGoldMarble = () => {
                if (typeof playSound === 'function') playSound('win', audioCtx);
                if (viewMode === 'mini') { setMarbles(m => m + 5); return; }
                if (!isPhysicsReady || !engineRef.current || !renderRef.current) return;

                const w = renderRef.current.options.width;
                const safeWidth = w * 0.9;
                const x = (w * 0.05) + (Math.random() * safeWidth);

                const ball = createMarbleBody(w, true, 0, x, -50);
                
                Matter.World.add(engineRef.current.world, ball);
                setMarbles(m => m + 5);
                checkWin(marbles + 5);
            };

            const checkWin = (currentCount) => {
                if (currentCount >= target) {
                    setTimeout(() => {
                        if (typeof playSound === 'function') playSound('win', audioCtx);
                        const canvas = document.querySelector('canvas'); 
                        if(canvas && typeof FireConfetti === 'function') FireConfetti(canvas);
                    }, 500);
                }
            };

            const pickWinner = () => {
                if (!engineRef.current || marbles === 0) return;
                shakeJar();
                const bodies = Matter.Composite.allBodies(engineRef.current.world);
                const marblesOnly = bodies.filter(b => b.label === 'marble');
                if (marblesOnly.length > 0) {
                    const winnerBody = marblesOnly[Math.floor(Math.random() * marblesOnly.length)];
                    setRaffleWinner(winnerBody.customLabel);
                    if (typeof playSound === 'function') {
                        playSound('drumroll', audioCtx);
                        setTimeout(() => playSound('win', audioCtx), 1000);
                    }
                    winnerBody.render.fillStyle = '#fcd34d'; 
                    winnerBody.render.strokeStyle = '#fff';
                    Matter.Body.setVelocity(winnerBody, { x: 0, y: -20 });
                }
            };

            const removeMarble = () => {
                if (marbles > 0) {
                    setMarbles(m => Math.max(0, m - 1));
                    if (viewMode === 'mini' || !engineRef.current) return;
                    const bodies = Matter.Composite.allBodies(engineRef.current.world);
                    const marblesOnly = bodies.filter(b => b.label === 'marble').sort((a, b) => a.position.y - b.position.y);
                    if (marblesOnly.length > 0) {
                        const removed = marblesOnly[0];
                        if (removed.isGold) setMarbles(m => Math.max(0, m - 4)); 
                        Matter.World.remove(engineRef.current.world, removed);
                    }
                }
            };

            const resetJar = () => {
                if(confirm("Empty the jar?")) {
                    setMarbles(0);
                    setRaffleWinner(null);
                    if (engineRef.current) {
                        const bodies = Matter.Composite.allBodies(engineRef.current.world);
                        const marblesOnly = bodies.filter(b => b.label === 'marble');
                        Matter.World.remove(engineRef.current.world, marblesOnly);
                    }
                }
            };

            const shakeJar = () => {
                if (!engineRef.current) return;
                const bodies = Matter.Composite.allBodies(engineRef.current.world);
                bodies.forEach(body => {
                    if (!body.isStatic) {
                        Matter.Body.applyForce(body, body.position, { x: (Math.random() - 0.5) * 0.3, y: -(Math.random() * 0.3 + 0.1) });
                    }
                });
                if (typeof playSound === 'function') playSound('clink', audioCtx);
            };

            // --- RENDER ---

            // 1. MINI VIEW
            if (viewMode === 'mini') {
                return (
                    <DraggableBox x={200} y={100} style={{zIndex:55}}>
                        <div style={{background: '#3b82f6', padding:'8px 16px', borderRadius:30, display:'flex', alignItems:'center', gap:10, boxShadow:'0 10px 30px rgba(0,0,0,0.3)', border:'2px solid white', color:'white'}}>
                            <Icons.Jar/> <span style={{fontWeight:700}}>{marbles}/{target}</span>
                            <button onClick={addMarble} style={{background:'rgba(255,255,255,0.2)', border:'none', borderRadius:'50%', width:24, height:24, cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center', color:'white'}}>+</button>
                            <button onClick={() => setViewMode('window')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button>
                        </div>
                    </DraggableBox>
                );
            }

            // 2. FULLSCREEN VIEW
            if (viewMode === 'full') {
                return (
                    <div style={{position:'fixed', inset:0, zIndex:100, background:'rgba(15,23,42,0.98)', display:'flex', flexDirection:'column', alignItems:'center', padding: '10px 20px'}}>
                        <div style={{width: '100%', maxWidth: 800, display: 'flex', justifyContent: 'space-between', alignItems: 'center', height: 80, flexShrink: 0, zIndex: 120}}>
                            <div style={{width: 100}}></div>
                            <div style={{display:'flex', flexDirection:'column', alignItems:'center'}}>
                                <div style={{
                                    background: showWinBanner ? '#22c55e' : 'rgba(255,255,255,0.1)', 
                                    padding: '5px 30px', borderRadius: 20, 
                                    border: '2px solid rgba(255,255,255,0.2)', 
                                    fontSize: showWinBanner ? '3rem' : '2.5rem', 
                                    fontWeight: 900, color: '#fff', textAlign: 'center',
                                    transition: 'all 0.3s ease',
                                    textShadow: '0 2px 10px rgba(0,0,0,0.3)'
                                }}>
                                    {showWinBanner ? (reward ? `ðŸŽ‰ ${reward}!` : "GOAL REACHED!") : `${marbles} / ${target}`}
                                </div>
                                {raffleWinner && (<div style={{marginTop: 10, background: '#fcd34d', color: '#78350f', padding: '5px 15px', borderRadius: 10, fontWeight: 800, animation: 'modalPop 0.5s'}}>WINNER: {raffleWinner}</div>)}
                            </div>
                            <div style={{display:'flex', gap:10, width:100, justifyContent:'flex-end'}}>
                                <button onClick={() => setViewMode('window')} className="btn" style={{background:'rgba(255,255,255,0.1)', fontSize:'1.2rem', padding:'10px'}} title="Shrink"><Icons.Minimize/></button>
                                <button onClick={onClose} className="btn" style={{background:'rgba(239,68,68,0.2)', color:'#ef4444', fontSize:'1.2rem', padding:'10px'}}><Icons.X/></button>
                            </div>
                        </div>

                        <div style={{flex: 1, display:'flex', alignItems:'center', justifyContent:'center', width:'100%', position:'relative', minHeight: 0}}>
                            <div ref={jarWrapperRef} style={{position: 'relative', width: '100%', maxWidth: 600, height: '100%'}}>
                                {showSlotEditor && (
                                    <div style={{position:'absolute', inset:0, background:'rgba(0,0,0,0.8)', zIndex:20, display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', padding:20, backdropFilter:'blur(5px)'}}>
                                        <h3 style={{color:'white', marginBottom:10}}>Edit Slots</h3>
                                        <textarea value={customSlotInput} onChange={(e)=>setCustomSlotInput(e.target.value)} style={{width:'100%', height:100, marginBottom:10, background:'rgba(255,255,255,0.1)', color:'white', border:'1px solid rgba(255,255,255,0.2)', borderRadius:8, padding:10}} placeholder="Enter labels separated by commas..."/>
                                        <button onClick={()=>setShowSlotEditor(false)} className="btn" style={{background:'#3b82f6', color:'white'}}>Done</button>
                                    </div>
                                )}
                                <div style={{position: 'absolute', top: -20, left: -5, right: -5, height: 30, borderRadius: '15px', border: '5px solid rgba(255,255,255,0.4)', background: 'linear-gradient(to right, rgba(255,255,255,0.2), rgba(255,255,255,0.05))', zIndex: 10}}></div>
                                <div ref={sceneRef} style={{position: 'absolute', inset: 0, borderLeft: '5px solid rgba(255,255,255,0.3)', borderRight: '5px solid rgba(255,255,255,0.3)', borderBottom: '8px solid rgba(255,255,255,0.4)', borderRadius: '0 0 50px 50px', background: 'linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01))', boxShadow: 'inset 0 0 40px rgba(255,255,255,0.1), 0 20px 50px rgba(0,0,0,0.5)', backdropFilter: 'blur(3px)'}} />
                                <div style={{position: 'absolute', top: 20, left: 20, width: '25%', bottom: 30, background: 'linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%)', borderRadius: '0 0 20px 30px', pointerEvents: 'none'}}></div>
                            </div>
                        </div>

                        <div style={{display:'flex', gap:20, marginTop:10, width: '100%', maxWidth: 800, justifyContent:'center', alignItems:'center', zIndex: 120, flexShrink: 0, paddingBottom: 20}}>
                            <div style={{display:'flex', flexDirection:'column', gap:5}}>
                                <div style={{display:'flex', gap:5}}>
                                    <button onClick={()=>setShowSlots(!showSlots)} className="btn" style={{fontSize:'0.8rem', padding:'2px 8px', background: showSlots ? '#10b981' : 'rgba(255,255,255,0.1)'}}>{showSlots ? 'Slots ON' : 'Slots OFF'}</button>
                                    {showSlots && (
                                        <select value={slotType} onChange={(e)=>setSlotType(e.target.value)} className="btn" style={{fontSize:'0.8rem', padding:'2px', width:80}}>
                                            <option value="numbers">1-5</option>
                                            <option value="prizes">Prizes</option>
                                            <option value="teams">Teams</option>
                                            <option value="multi">xMulti</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    )}
                                    {showSlots && slotType === 'custom' && <button onClick={()=>setShowSlotEditor(true)} className="btn" style={{padding:'2px 5px'}}>Edit</button>}
                                </div>
                                <select value={ballSize} onChange={(e)=>setBallSize(e.target.value)} className="btn" style={{background:'rgba(255,255,255,0.1)', fontSize:'0.8rem'}}>
                                    <option value="small" style={{color:'black'}}>Sm Ball</option>
                                    <option value="medium" style={{color:'black'}}>Med Ball</option>
                                    <option value="large" style={{color:'black'}}>Lg Ball</option>
                                </select>
                                <button onClick={() => setLabelMode(labelMode === 'number' ? 'name' : 'number')} className="btn" style={{background: labelMode === 'name' ? '#8b5cf6' : 'rgba(255,255,255,0.1)', fontSize:'0.8rem'}}>
                                    {labelMode === 'number' ? '[123]' : '[ABC]'}
                                </button>
                                <button onClick={() => setIsPlinko(!isPlinko)} className="btn" style={{background: isPlinko ? '#10b981' : 'rgba(255,255,255,0.1)', fontSize:'0.8rem'}}>
                                    {isPlinko ? 'Pegs ON' : 'Pegs OFF'}
                                </button>
                            </div>
                            <div style={{display:'flex', gap: 5}}>
                                <button onClick={addMarble} className="btn" style={{background: '#22c55e', fontSize:'2rem', padding:'15px 40px', borderRadius: 50, boxShadow:'0 10px 30px rgba(34,197,94,0.4)', border:'2px solid #86efac'}}>+ Drop</button>
                                <button onClick={addGoldMarble} className="btn" style={{background: '#f59e0b', fontSize:'1.5rem', padding:'15px 20px', borderRadius: 50, boxShadow:'0 10px 30px rgba(245,158,11,0.4)', border:'2px solid #fcd34d', color:'#fff'}}>+5 Gold</button>
                            </div>
                            <div style={{display:'flex', flexDirection:'column', gap: 5}}>
                                <button onClick={pickWinner} className="btn" style={{background:'#f59e0b', color: 'white', fontWeight:'bold', padding:'10px 20px'}}>Draw Winner</button>
                                <div style={{display:'flex', gap:5}}>
                                    <button onClick={shakeJar} className="btn" style={{background:'rgba(255,255,255,0.1)', flex:1}}>Shake</button>
                                    <button onClick={removeMarble} className="btn" style={{background:'rgba(255,255,255,0.1)', flex:1}}>Undo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // WINDOW VIEW
            return (
                <DraggableBox x={200} y={100} style={{zIndex:55}}>
                    <div style={{
                        width: jarSize === 'small' ? 240 : jarSize === 'large' ? 440 : 320, 
                        minHeight: 450, 
                        background: 'rgba(15, 23, 42, 0.95)', backdropFilter: 'blur(15px)',
                        borderRadius: 20, border: '1px solid rgba(255,255,255,0.1)',
                        boxShadow: '0 20px 60px rgba(0,0,0,0.6)', display:'flex', flexDirection:'column', padding: 16,
                        resize: 'both', overflow: 'hidden', minWidth: 240
                    }}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:10}}>
                            <span style={{fontWeight:800, color:'white', display:'flex', gap:8}}><Icons.Jar/> Marble Jar</span>
                            <div style={{display:'flex', gap:4}}>
                                <button onClick={()=>setViewMode('full')} className="btn" style={{padding:4, background:'transparent'}} title="Fullscreen"><Icons.Maximize/></button>
                                <button onClick={()=>setViewMode('mini')} className="btn" style={{padding:4, background:'transparent'}} title="Minimize"><Icons.Minimize/></button>
                                <button onClick={onClose} className="btn" style={{padding:4, background:'transparent', color:'#ef4444'}}><Icons.X/></button>
                            </div>
                        </div>

                        {raffleWinner && (<div style={{marginBottom: 10, background: '#fcd34d', color: '#78350f', padding: '5px', borderRadius: 6, fontWeight: 800, textAlign:'center', animation: 'modalPop 0.5s'}}>WINNER: {raffleWinner}</div>)}

                        <div style={{flex: 1, display:'flex', justifyContent:'center', padding: '10px 0', overflow:'hidden', position:'relative', minHeight:0}}>
                            <div ref={jarWrapperRef} style={{position:'relative', width:'100%', height:'100%', minHeight: 300}}>
                                {showSlotEditor && (
                                    <div style={{position:'absolute', inset:0, background:'rgba(0,0,0,0.8)', zIndex:20, display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', padding:20, backdropFilter:'blur(5px)', borderRadius: 20}}>
                                        <h3 style={{color:'white', marginBottom:10}}>Edit Slots</h3>
                                        <textarea value={customSlotInput} onChange={(e)=>setCustomSlotInput(e.target.value)} style={{width:'100%', height:80, marginBottom:10, background:'rgba(255,255,255,0.1)', color:'white', border:'1px solid rgba(255,255,255,0.2)', borderRadius:8, padding:10}} placeholder="Enter labels separated by commas..."/>
                                        <button onClick={()=>setShowSlotEditor(false)} className="btn" style={{background:'#3b82f6', color:'white'}}>Done</button>
                                    </div>
                                )}
                                <div style={{position: 'absolute', top: -12, left: -2, right: -2, height: 24, borderRadius: '12px', border: '4px solid rgba(255,255,255,0.4)', background: 'linear-gradient(to right, rgba(255,255,255,0.2), rgba(255,255,255,0.05))', zIndex: 10}}></div>
                                <div ref={sceneRef} style={{position: 'absolute', inset: 0, borderLeft: '4px solid rgba(255,255,255,0.3)', borderRight: '4px solid rgba(255,255,255,0.3)', borderBottom: '8px solid rgba(255,255,255,0.4)', borderRadius: '0 0 40px 40px', background: 'linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01))', boxShadow: 'inset 0 0 30px rgba(255,255,255,0.1), 0 20px 50px rgba(0,0,0,0.5)', backdropFilter: 'blur(3px)'}} />
                                <div style={{position: 'absolute', top: 15, left: 15, width: '20%', bottom: 25, background: 'linear-gradient(to right, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.02) 100%)', borderRadius: '0 0 20px 30px', pointerEvents: 'none'}}></div>
                            </div>
                        </div>

                        <div style={{marginTop: 10, display:'flex', flexDirection:'column', gap: 10}}>
                            <div style={{display:'flex', gap: 10}}>
                                <button onClick={addMarble} className="btn" style={{flex:2, justifyContent:'center', background:'#22c55e', color:'white', boxShadow:'0 4px 10px rgba(34,197,94,0.3)', fontSize:'1.1rem', fontWeight:'bold'}}>+ Drop</button>
                                <button onClick={pickWinner} className="btn" style={{flex:1, justifyContent:'center', background:'#f59e0b', color:'white', fontSize:'0.9rem', fontWeight:'bold'}}>Draw</button>
                            </div>
                            
                            <div style={{display:'flex', alignItems:'center', gap: 8, justifyContent:'space-between', background:'rgba(0,0,0,0.2)', padding:8, borderRadius:8}}>
                                <div style={{display:'flex', alignItems:'center', gap:5}}>
                                    <span style={{fontSize:'0.7rem', opacity:0.7, textTransform:'uppercase'}}>Goal</span>
                                    <input type="number" value={target} onChange={(e)=>setTarget(Number(e.target.value))} style={{width: 40, background:'rgba(255,255,255,0.1)', border:'none', borderRadius:4, color:'white', padding:2, textAlign:'center'}} />
                                    <input type="text" value={reward || ""} onChange={(e)=>setReward(e.target.value)} placeholder="Reward..." style={{width: 70, background:'rgba(255,255,255,0.1)', border:'none', borderRadius:4, color:'white', padding:'2px 6px', fontSize:'0.8rem', marginLeft: 6}} />
                                </div>
                                <div style={{display:'flex', flexDirection:'column', gap:2}}>
                                    <div style={{display:'flex', gap:2}}>
                                        <button onClick={()=>setShowSlots(!showSlots)} className="btn" style={{fontSize:'0.7rem', padding:'2px', background: showSlots ? '#10b981' : 'rgba(255,255,255,0.1)'}}>{showSlots ? 'Slots' : 'No Slots'}</button>
                                        {showSlots && (
                                            <select value={slotType} onChange={(e)=>setSlotType(e.target.value)} className="btn" style={{fontSize:'0.7rem', padding:'0px', width:50}}>
                                                <option value="numbers">1-5</option>
                                                <option value="prizes">Prize</option>
                                                <option value="teams">Team</option>
                                                <option value="custom">Edit</option>
                                            </select>
                                        )}
                                        {showSlots && slotType === 'custom' && <button onClick={()=>setShowSlotEditor(true)} className="btn" style={{padding:'2px 5px', fontSize:'0.7rem'}}>Edit</button>}
                                    </div>
                                    <button onClick={() => setIsPlinko(!isPlinko)} className="btn" style={{fontSize:'0.7rem', padding:'2px', background: isPlinko ? '#10b981' : 'rgba(255,255,255,0.1)'}}>
                                        {isPlinko ? 'Pegs ON' : 'Pegs OFF'}
                                    </button>
                                </div>
                                <div style={{display:'flex', flexDirection:'column', gap:2}}>
                                    <button onClick={shakeJar} className="btn" style={{fontSize:'0.7rem', padding:'2px', background:'rgba(255,255,255,0.1)'}}>Shake</button>
                                    <button onClick={resetJar} className="btn" style={{fontSize:'0.7rem', padding:'2px', background:'rgba(239,68,68,0.2)', color:'#ef4444'}}>Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </DraggableBox>
            );
        };

        // --- 4. MAIN APP ---
        function App() {
        const toggleFullScreen = () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
            console.warn(`Error attempting to enable full-screen mode: ${err.message}`);
        });
        setProjectorMode(true);
    } else {
        document.exitFullscreen();
        setProjectorMode(false);
    }
};
          const [names, setNames] = useState(defaultNames);
          const [inputText, setInputText] = useState(defaultNames.join('\n'));
          const [savedLists, setSavedLists] = useState({}); const [newListName, setNewListName] = useState("");
          const [currentThemeId, setCurrentThemeId] = useState('default');
          const [isSpinning, setIsSpinning] = useState(false);
          const [winner, setWinner] = useState(null); const [winnerHistory, setWinnerHistory] = useState([]);
          const [soundEnabled, setSoundEnabled] = useState(true);
          const [soundTheme, setSoundTheme] = useState('standard');
          const [mysteryMode, setMysteryMode] = useState(false); const [showSettings, setShowSettings] = useState(false);
          const [projectorMode, setProjectorMode] = useState(false);
          const [showTimer, setShowTimer] = useState(false);
          const [hubImage, setHubImage] = useState(null); const [showHelp, setShowHelp] = useState(false);
          const [showImport, setShowImport] = useState(false);
          const [showGroups, setShowGroups] = useState(false);
          const [hiddenNames, setHiddenNames] = useState([]); 
          const [concepts, setConcepts] = useState(defaultConcepts); 
          const [showConceptEdit, setShowConceptEdit] = useState(false);
          const [battleMode, setBattleMode] = useState(false);
          const [battleStage, setBattleStage] = useState('idle');
          const [battleContestants, setBattleContestants] = useState([null, null]);
          const [bloomMode, setBloomMode] = useState('off'); 
          const [bloomWinner, setBloomWinner] = useState(null);
          const [activeTeams, setActiveTeams] = useState([]); const [teamScores, setTeamScores] = useState([]);
          const [fairMode, setFairMode] = useState(false);
          const [winnerTimerActive, setWinnerTimerActive] = useState(false);
          const [rapidMode, setRapidMode] = useState(false);
          const [rapidTarget, setRapidTarget] = useState(3);
          const [rapidWinners, setRapidWinners] = useState([]);
          
          // WIDGET VIEW STATES
          const [meterView, setMeterView] = useState('window');
          const [todoView, setTodoView] = useState('window');
          const [pollView, setPollView] = useState('window');
          const [breakView, setBreakView] = useState('window');
          const [showSeating, setShowSeating] = useState(false);
          const [showMarbleJar, setShowMarbleJar] = useState(false);

          // NEW LIFTED STATE FOR GLOBAL SAVE
          const [marbles, setMarbles] = useState(0);
          const [marbleTarget, setMarbleTarget] = useState(10);
          const [marbleReward, setMarbleReward] = useState("");

          // NOISE METER
          const [showNoiseMeter, setShowNoiseMeter] = useState(false);
          const [meterActive, setMeterActive] = useState(false);
          const [volume, setVolume] = useState(0);
          const audioCtxRefMeter = useRef(null);
          const analyserRef = useRef(null);
          const sourceRef = useRef(null);

          const toggleMic = async () => {
              if (meterActive) {
                  if(audioCtxRefMeter.current) audioCtxRefMeter.current.close();
                  setMeterActive(false); setVolume(0); return;
              }
              try {
                  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                  audioCtxRefMeter.current = new (window.AudioContext || window.webkitAudioContext)();
                  if (audioCtxRefMeter.current.state === 'suspended') await audioCtxRefMeter.current.resume();
                  analyserRef.current = audioCtxRefMeter.current.createAnalyser();
                  analyserRef.current.fftSize = 256;
                  sourceRef.current = audioCtxRefMeter.current.createMediaStreamSource(stream);
                  sourceRef.current.connect(analyserRef.current);
                  setMeterActive(true);
                  checkVolumeLoop();
              } catch (err) { alert("Could not access microphone. Please check permissions."); }
          };
          const checkVolumeLoop = () => {
              if (audioCtxRefMeter.current && audioCtxRefMeter.current.state === 'running') {
                  const dataArray = new Uint8Array(analyserRef.current.frequencyBinCount);
                  analyserRef.current.getByteFrequencyData(dataArray);
                  const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
                  const adjusted = Math.min(100, Math.round(avg * 1.5));
                  setVolume(adjusted);
                  requestAnimationFrame(checkVolumeLoop);
              }
          };

          const [billboardMode, setBillboardMode] = useState('text'); 
          const [billboardText, setBillboardText] = useState("");
          const [stickies, setStickies] = useState([]);
          const addSticky = () => {
              const colors = ['#fef3c7', '#dbeafe', '#fce7f3', '#dcfce7'];
              const newNote = { id: Date.now(), text: "", color: colors[Math.floor(Math.random() * colors.length)], rotation: Math.random() * 6 - 3, x: 100 + Math.random() * 50, y: 100 + Math.random() * 50 };
              setStickies([...stickies, newNote]);
          };
          const updateSticky = (id, newText) => { setStickies(stickies.map(note => note.id === id ? { ...note, text: newText } : note)); };
          const deleteSticky = (id) => { setStickies(stickies.filter(note => note.id !== id)); };
          const [showBillboard, setShowBillboard] = useState(false);
          const [trafficLight, setTrafficLight] = useState('green'); 
          const [trafficMode, setTrafficMode] = useState('sidebar'); 
          const [scratchpad, setScratchpad] = useState(localStorage.getItem('spinner_scratchpad') || "");
          const [tempWheelItems, setTempWheelItems] = useState(null); 
          const [chanceAnim, setChanceAnim] = useState(null); 
          const [chanceResult, setChanceResult] = useState(null);
          
          const [showBrainBreak, setShowBrainBreak] = useState(false);
          const [breakAnim, setBreakAnim] = useState(false);
          const [currentBreak, setCurrentBreak] = useState({ title: "Ready?", icon: "ðŸš€", desc: "Click 'New Activity' to pick a strategy." });
          const kaganStrategies = [
              { title: "Think-Pair-Share", icon: "ðŸ¤”", desc: "1. Think about the answer silently.\n2. Pair up with a neighbor.\n3. Share your thoughts." },
              { title: "RallyRobin", icon: "ðŸ¦œ", desc: "1. Pair up.\n2. Partner A shares one idea.\n3. Partner B shares one idea.\n4. Repeat back and forth." },
              { title: "RoundRobin", icon: "ðŸ”„", desc: "1. In teams of 4.\n2. Student 1 shares.\n3. Go clockwise: Student 2, 3, 4 share.\n4. Continue until time is up." },
              { title: "Stand Up, Hand Up, Pair Up", icon: "âœ‹", desc: "1. Stand up and raise a hand.\n2. Walk around until you find a partner.\n3. High five, put hands down, and discuss." },
              { title: "Mix-Pair-Share", icon: "ðŸ”€", desc: "1. Class mixes around the room to music.\n2. Music stops: Pair with closest person.\n3. Teacher asks a question to discuss." },
              { title: "Timed Pair Share", icon: "â±ï¸", desc: "1. Partner A speaks for 30-60 seconds (Partner B listens).\n2. Partner B responds/praises.\n3. Switch roles." },
              { title: "RallyCoach", icon: "ðŸ‹ï¸", desc: "1. Partner A solves the problem.\n2. Partner B watches and coaches.\n3. Partner B praises.\n4. Switch roles for next problem." },
              { title: "Fan-N-Pick", icon: "ðŸƒ", desc: "1. S1 fans the cards.\n2. S2 picks a card & reads it.\n3. S3 answers.\n4. S4 paraphrases/praises.\n5. Rotate roles." },
              { title: "Inside-Outside Circle", icon: "â­•", desc: "1. Form two circles (inner facing out, outer facing in).\n2. Face a partner.\n3. Discuss/Quiz.\n4. Outer circle rotates one step left." },
              { title: "Quiz-Quiz-Trade", icon: "ðŸ”", desc: "1. Everyone has a card.\n2. Find a partner.\n3. Quiz each other.\n4. Trade cards and find a new partner." },
              { title: "One Stray", icon: "ðŸ•", desc: "1. Team works on a problem.\n2. One teammate 'strays' to a new team to share/compare answers.\n3. Strayer returns and reports back." },
              { title: "Gallery Walk", icon: "ðŸ–¼ï¸", desc: "1. Post work on walls.\n2. Teams rotate from poster to poster.\n3. Leave feedback on sticky notes." },
              { title: "Jigsaw", icon: "ðŸ§©", desc: "1. Become an expert on one topic.\n2. Form new groups with experts from other topics.\n3. Teach your piece to the group." },
              { title: "Numbered Heads", icon: "ðŸ”¢", desc: "1. Students number off 1-4.\n2. Team discusses question.\n3. Teacher calls a number (e.g., 'All 3s!').\n4. Only 3s answer." },
              { title: "Showdown", icon: "ðŸ¤ ", desc: "1. Captain reads question.\n2. Everyone writes answer secretly.\n3. Captain calls 'Showdown!'.\n4. Compare and discuss." },
              { title: "Talking Chips", icon: "ðŸª™", desc: "1. Everyone gets 2 chips.\n2. Place a chip in center to speak.\n3. Cannot speak again until all chips are used." },
              { title: "Find Someone Who", icon: "ðŸ•µï¸", desc: "1. Walk around with a worksheet.\n2. Find a classmate who knows an answer.\n3. Have them sign your sheet." },
              { title: "Corners", icon: "ðŸ—ï¸", desc: "1. Teacher labels corners (A, B, C, D).\n2. Students move to their choice.\n3. Pair up in your corner and discuss why." },
              { title: "3-Step Interview", icon: "ðŸŽ¤", desc: "1. A interviews B.\n2. C interviews D.\n3. RoundRobin: Everyone shares what their partner said." },
              { title: "Team Stand-N-Share", icon: "ðŸ§", desc: "1. All teams stand.\n2. Team 1 shares an idea.\n3. Other teams sit if they had the same idea on their list." },
              { title: "Spend-A-Buck", icon: "ðŸ’µ", desc: "1. Each student has $1.00 (4 quarters) to vote.\n2. Place quarters on preferred options.\n3. Option with most money wins." },
              { title: "Carousel Feedback", icon: "ðŸŽ ", desc: "1. Projects on desks.\n2. Teams rotate desk-to-desk.\n3. Discuss and leave feedback forms." },
              { title: "Stir-the-Class", icon: "ðŸ¥„", desc: "1. Teams stand in circle.\n2. Teacher asks question.\n3. Teams huddle. S1 moves to next team to share answer." },
              { title: "Telephone", icon: "ðŸ“ž", desc: "1. S1 whispers message to S2.\n2. Continue down the line.\n3. Last person says it out loud. Compare to original." },
              { title: "Pairs Compare", icon: "ðŸ‘¯", desc: "1. Shoulder partners list ideas.\n2. Pair with another couple.\n3. Compare lists and add missing items." }
          ];
          const pickBrainBreak = () => {
              setBreakAnim(true);
              let count = 0; const max = 12;
              const interval = setInterval(() => {
                  const randomIdx = Math.floor(Math.random() * kaganStrategies.length);
                  setCurrentBreak(kaganStrategies[randomIdx]);
                  count++;
                  if (count >= max) { clearInterval(interval); setBreakAnim(false); playSound('win', audioCtxRef, soundTheme); } 
                  else { playSound('tick', audioCtxRef, soundTheme); }
              }, 100);
          };

          const [showPoll, setShowPoll] = useState(false);
          const [pollCounts, setPollCounts] = useState({ A: 0, B: 0, C: 0, D: 0 });
          const [showLineup, setShowLineup] = useState(false);
          const [lineupList, setLineupList] = useState([]);
          const [isLineupAnimating, setIsLineupAnimating] = useState(false);
          
          const generateLineup = () => {
              const currentStudents = activeNames.length > 0 ? activeNames : names;
              setShowLineup(true); setIsLineupAnimating(true);
              let count = 0; const maxTicks = 15;
              const interval = setInterval(() => {
                  const tempShuffle = [...currentStudents].sort(() => Math.random() - 0.5);
                  setLineupList(tempShuffle);
                  if(soundEnabled) playSound('tick', audioCtxRef, soundTheme);
                  count++;
                  if (count >= maxTicks) {
                      clearInterval(interval);
                      const finalShuffle = [...currentStudents].sort(() => Math.random() - 0.5);
                      setLineupList(finalShuffle);
                      setIsLineupAnimating(false);
                      if(soundEnabled) playSound('win', audioCtxRef, soundTheme);
                  }
              }, 80);
          };

          const [showTodo, setShowTodo] = useState(false);
          const [todoList, setTodoList] = useState([]);
          const [todoInput, setTodoInput] = useState("");
          const [todoFullscreen, setTodoFullscreen] = useState(false);
          const [pollFullscreen, setPollFullscreen] = useState(false);
          const [breakFullscreen, setBreakFullscreen] = useState(false);

          const addTodo = () => {
              if (!todoInput.trim()) return;
              const newTask = { id: Date.now(), text: todoInput.trim(), done: false };
              setTodoList([...todoList, newTask]);
              setTodoInput("");
          };
          const toggleTodo = (id) => { setTodoList(todoList.map(t => t.id === id ? { ...t, done: !t.done } : t)); };
          const deleteTodo = (id) => { setTodoList(todoList.filter(t => t.id !== id)); };
          const updatePoll = (key, delta) => { setPollCounts(prev => ({ ...prev, [key]: Math.max(0, prev[key] + delta) })); };

          useEffect(() => { localStorage.setItem('spinner_scratchpad', scratchpad); }, [scratchpad]);

          const runChance = (type) => {
              if (type === 'num') {
                  const numbers = Array.from({length: 10}, (_, i) => (i + 1).toString());
                  setTempWheelItems(numbers); setTimeout(() => spin(), 100);
              } else if (type === 'coin') {
                  setChanceResult(Math.random() < 0.5 ? "HEADS" : "TAILS"); setChanceAnim('coin');
              } else if (type === 'dice') {
                  setChanceResult(Math.floor(Math.random() * 6) + 1); setChanceAnim('dice');
              }
          };

          const [participation, setParticipation] = useState({});
          const [showHeatmap, setShowHeatmap] = useState(false);

          const fileInputRef = useRef(null); 
          const canvasRef = useRef(null); const canvasRef2 = useRef(null);
          const confettiCanvasRef = useRef(null); const containerRef = useRef(null); const audioCtxRef = useRef(null); 
          const rotationRef = useRef(0); const rotationRef2 = useRef(0);
          const velocityRef = useRef(0); const velocityRef2 = useRef(0);
          const lastTickRef = useRef(0); const isSpinningRef = useRef(false); 
          const pointerRef = useRef(0); const pointerRef2 = useRef(0); 

          const theme = THEMES[currentThemeId];
          const activeNames = useMemo(() => tempWheelItems || names.filter(n => !hiddenNames.includes(n)), [names, hiddenNames, tempWheelItems]);
          useEffect(() => { const saved = localStorage.getItem('spinner_lists'); if(saved) setSavedLists(JSON.parse(saved)); }, []);

          const saveList = () => { 
              const nameToSave = newListName.trim();
              if(!nameToSave) return;
              if (savedLists[nameToSave]) {
                  if (!window.confirm(`Class "${nameToSave}" already exists.\n\nDo you want to UPDATE it with the current names and settings?`)) { return; }
              }
              const saveData = {
                  names: names, 
                  theme: currentThemeId, 
                  bloomMode: bloomMode, 
                  battleMode: battleMode,
                  mysteryMode: mysteryMode, 
                  concepts: concepts, 
                  soundTheme: soundTheme, 
                  fairMode: fairMode, 
                  rapidTarget: rapidTarget,
                  // NEW: Save additional state
                  stickies: stickies,
                  participation: participation,
marbles: marbles,
marbleTarget: marbleTarget,
marbleReward: marbleReward
              };
              setSavedLists(prev => {
                  const updated = {...prev, [nameToSave]: saveData};
                  try { localStorage.setItem('spinner_lists', JSON.stringify(updated)); } catch(e) { alert("Error: Could not save to browser storage (Quota Exceeded?)"); }
                  return updated;
              });
              alert(`Session "${nameToSave}" saved successfully!`);
          };

          const handleLoadClass = (key) => {
              const data = savedLists[key];
              if (!data) return;
              setNewListName(key); 
              
              if (Array.isArray(data)) {
                  // Legacy format (just array of names)
                  setNames(data); setInputText(data.join('\n'));
                  setBattleMode(false); setBloomMode('off'); setMysteryMode(false);
                  setStickies([]); setParticipation({}); setMarbles(0);
              } else {
                  // New object format
                  if(data.names) { setNames(data.names); setInputText(data.names.join('\n')); }
                  if(data.theme) setCurrentThemeId(data.theme);
                  if(data.bloomMode !== undefined) setBloomMode(data.bloomMode);
                  if(data.battleMode !== undefined) setBattleMode(data.battleMode);
                  if(data.mysteryMode !== undefined) setMysteryMode(data.mysteryMode);
                  if(data.concepts) setConcepts(data.concepts);
                  if(data.soundTheme) setSoundTheme(data.soundTheme);
                  if(data.fairMode !== undefined) setFairMode(data.fairMode);
                  if(data.rapidTarget) setRapidTarget(data.rapidTarget);
                  
                  // Load new fields
                  if(data.stickies) setStickies(data.stickies); else setStickies([]);
                  if(data.participation) setParticipation(data.participation); else setParticipation({});
                  if(data.marbles !== undefined) setMarbles(data.marbles);
                  if(data.marbleTarget !== undefined) setMarbleTarget(data.marbleTarget);
                  if(data.marbleReward !== undefined) setMarbleReward(data.marbleReward); else setMarbleReward("");
              }
              setHiddenNames([]); setWinner(null);
          };

          const handleDeleteClass = (e, key) => {
              e.preventDefault(); e.stopPropagation(); 
              if (window.confirm(`Are you sure you want to permanently delete "${key}"?\n\nThis cannot be undone.`)) {
                  setSavedLists(prev => {
                      const updated = { ...prev }; delete updated[key];
                      localStorage.setItem('spinner_lists', JSON.stringify(updated)); return updated;
                  });
              }
          };
          
          const updateNames = (t) => { setInputText(t); setNames(t.split('\n').filter(n=>n.trim())); };
          const performImport = (l) => { setNames(l); setInputText(l.join('\n')); setShowImport(false); setHiddenNames([]); setParticipation({}); };
          const toggleHidden = (n) => { setHiddenNames(prev => prev.includes(n) ? prev.filter(x => x !== n) : [...prev, n]); };
          const shuffleNames = () => { const s=[...names].sort(()=>Math.random()-0.5); setInputText(s.join('\n')); setNames(s); };
          
          const removeWinner = () => {
            if (winner && !rapidMode && winner !== "Group Complete!" && !tempWheelItems) {
                 setHiddenNames(prev => [...prev, winner]);
            }
            setWinner(null); setBloomWinner(null); setTempWheelItems(null); setChanceAnim(null); setWinnerTimerActive(false); 
            if(rapidMode) { setRapidMode(false); setRapidWinners([]); }
          };

          const handleImageUpload = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(evt)=>{ const i=new Image(); i.onload=()=>{setHubImage(i);
          if(canvasRef.current)drawWheel(canvasRef.current, bloomMode === 'solo' ? concepts : activeNames, rotationRef.current, pointerRef.current, mysteryMode);}; i.src=evt.target.result; }; r.readAsDataURL(f); } };
          const handleStartScoring = (g) => { setActiveTeams(g); setTeamScores(new Array(g.length).fill(0)); setShowGroups(false); };
          const handleUpdateScore = (i,c) => { const n=[...teamScores]; n[i]+=c; setTeamScores(n); if(soundEnabled) playSound('tick', audioCtxRef, soundTheme); };
          const toggleBloomMode = () => { setBattleMode(false); if (bloomMode === 'off') setBloomMode('solo'); else if (bloomMode === 'solo') setBloomMode('dual'); else setBloomMode('off'); };

          const startRapidFire = (count) => {
              setRapidMode(true); setRapidTarget(count); setRapidWinners([]); spin();
          };

          const exportCSV = () => {
              let csvContent = "data:text/csv;charset=utf-8,Name,Count\n";
              names.forEach(n => { csvContent += `${n},${participation[n] || 0}\n`; });
              const encodedUri = encodeURI(csvContent);
              const link = document.createElement("a");
              link.setAttribute("href", encodedUri); link.setAttribute("download", "class_participation.csv");
              document.body.appendChild(link); link.click(); document.body.removeChild(link);
          };

          const drawWheel = (canvas, items, currentRotation, currentPointer, isMystery) => {
            if (!canvas) return;
            let size = 300; 
            const isDual = bloomMode === 'dual';
            if (isDual && containerRef.current && containerRef.current.offsetWidth > 0) size = Math.min(containerRef.current.offsetWidth / 2.2, containerRef.current.offsetHeight) * 0.95;
            else if (containerRef.current && containerRef.current.offsetWidth > 0) size = Math.min(containerRef.current.offsetWidth, containerRef.current.offsetHeight) * 0.95;
            if (size < 50) size = 300;
            if (canvas.width !== size || canvas.height !== size) { canvas.width = size; canvas.height = size; }
            const ctx = canvas.getContext('2d'); if (!ctx) return;
            const { width, height } = canvas; const cx = width / 2; const cy = height / 2;
            const radius = Math.max(0, width / 2 - 25);
            ctx.clearRect(0, 0, width, height);
            if (items.length === 0) { ctx.fillStyle = theme.text; ctx.font = "16px sans-serif"; ctx.textAlign = "center"; ctx.fillText("No items!", cx, cy); return; }
            items.forEach((name, i) => {
              const start = i * (2 * Math.PI / items.length) + currentRotation; const end = (i + 1) * (2 * Math.PI / items.length) + currentRotation;
              ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, radius, start, end); ctx.fillStyle = theme.colors[i % theme.colors.length]; ctx.fill();
              const g = ctx.createRadialGradient(cx, cy, radius * 0.2, cx, cy, radius); g.addColorStop(0, 'rgba(255,255,255,0.15)'); g.addColorStop(1, 'rgba(0,0,0,0.15)'); ctx.fillStyle = g; ctx.fill();
              ctx.strokeStyle = theme.bg; ctx.lineWidth = 2; ctx.stroke();
              ctx.save(); ctx.translate(cx, cy); ctx.rotate(start + (end - start) / 2); ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = `bold ${Math.max(12, Math.min(24, 250 / items.length))}px sans-serif`; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4; 
              const shouldHide = isMystery && isSpinningRef.current && items === activeNames;
              ctx.fillText(shouldHide ? "?" : name.substring(0, 18), radius - 20, 6); ctx.restore();
            });
            items.forEach((_, i) => { const a = i * (2 * Math.PI / items.length) + currentRotation; ctx.save(); ctx.translate(cx, cy); ctx.rotate(a); ctx.beginPath(); ctx.arc(radius - 2, 0, 4, 0, Math.PI * 2); const pg = ctx.createRadialGradient(radius - 5, -2, 0, radius - 2, 0, 6); pg.addColorStop(0, '#ffffff'); pg.addColorStop(1, '#64748b'); ctx.fillStyle = pg; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 3; ctx.fill(); ctx.restore(); });
            ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, 35, 0, 2 * Math.PI); ctx.closePath(); ctx.clip();
            if (hubImage && items === activeNames) { ctx.drawImage(hubImage, cx - 35, cy - 35, 70, 70);
            } else { const hg = ctx.createRadialGradient(cx, cy, 10, cx, cy, 35); hg.addColorStop(0, '#fef3c7'); hg.addColorStop(1, '#b45309'); ctx.fillStyle = hg; ctx.fill();
            ctx.save(); ctx.translate(cx, cy); ctx.beginPath(); for (let i = 0; i < 5; i++) { ctx.lineTo(Math.cos((18 + i * 72) * Math.PI / 180) * 18, -Math.sin((18 + i * 72) * Math.PI / 180) * 18);
            ctx.lineTo(Math.cos((54 + i * 72) * Math.PI / 180) * 8, -Math.sin((54 + i * 72) * Math.PI / 180) * 8);
            } ctx.closePath(); ctx.fillStyle = "#fff"; ctx.shadowColor = "rgba(180, 83, 9, 0.5)"; ctx.shadowBlur = 5; ctx.fill(); ctx.restore(); } ctx.restore();
            ctx.beginPath(); ctx.arc(cx, cy, 35, 0, 2 * Math.PI); ctx.strokeStyle = "#b45309"; ctx.lineWidth = 4; ctx.stroke();
            ctx.save(); ctx.translate(width - 10, cy); ctx.rotate(currentPointer);
            ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(-40, 0); ctx.lineTo(0, 15); ctx.closePath(); ctx.fillStyle = theme.text; ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 5; ctx.fill(); ctx.restore();
          };

          const spin = () => {
            if (isSpinning || (bloomMode !== 'solo' && activeNames.length < 2)) return;
            setWinner(null); setBloomWinner(null); setWinnerTimerActive(false);
            if (battleMode && battleStage === 'idle') { setBattleStage('spinning1'); setBattleContestants([null, null]); }
            velocityRef.current = 0.4 + Math.random() * 0.4;
            if (bloomMode === 'dual') velocityRef2.current = 0.4 + Math.random() * 0.3;
            isSpinningRef.current = true; setIsSpinning(true);
          };

          useEffect(() => {
            if (!isSpinning) return;
            let af;
            const animate = () => {
                pointerRef.current *= 0.85;
                if (velocityRef.current > 0.002) {
                    velocityRef.current *= 0.985; rotationRef.current += velocityRef.current;
                    if (rotationRef.current >= Math.PI * 2) rotationRef.current -= Math.PI * 2;
                    const currentList = bloomMode === 'solo' ? concepts : activeNames;
                    if (soundEnabled && currentList.length > 0) {
                         const slice = (2 * Math.PI) / currentList.length; const passed = Math.floor(rotationRef.current / slice);
                         if (passed !== lastTickRef.current) { playSound('tick', audioCtxRef, soundTheme); lastTickRef.current = passed; pointerRef.current = 0.3 + Math.random() * 0.1; }
                    }
                } else velocityRef.current = 0;

                if (bloomMode === 'dual') {
                    pointerRef2.current *= 0.85;
                    if (velocityRef2.current > 0.002) { velocityRef2.current *= 0.985; rotationRef2.current += velocityRef2.current;
                    if (rotationRef2.current >= Math.PI * 2) rotationRef2.current -= Math.PI * 2;
                    } else velocityRef2.current = 0;
                }

                const mainList = bloomMode === 'solo' ? concepts : activeNames;
                drawWheel(canvasRef.current, mainList, rotationRef.current, pointerRef.current, mysteryMode);
                if (bloomMode === 'dual') drawWheel(canvasRef2.current, concepts, rotationRef2.current, pointerRef2.current, false);
                if (velocityRef.current === 0 && (bloomMode !== 'dual' || velocityRef2.current === 0)) {
                    isSpinningRef.current = false; pointerRef.current = 0; pointerRef2.current = 0; setIsSpinning(false);
                    let w = null;
                    if (mainList.length > 0) { const slice = (2 * Math.PI) / mainList.length;
                    let p = (0 - rotationRef.current) % (2 * Math.PI); if (p < 0) p += 2 * Math.PI;
                    const i = Math.floor(p / slice); if (i >= 0 && i < mainList.length) w = mainList[i];
                    }
                    let bw = null;
                    if (bloomMode === 'dual') { const slice = (2 * Math.PI) / concepts.length;
                    let p = (0 - rotationRef2.current) % (2 * Math.PI); if (p < 0) p += 2 * Math.PI;
                    const i = Math.floor(p / slice); if (i >= 0 && i < concepts.length) bw = concepts[i];
                    }

                    if (rapidMode && w) {
                         const newWinners = [...rapidWinners, w];
                         setRapidWinners(newWinners); setHiddenNames(prev => [...prev, w]); 
                         setParticipation(prev => ({ ...prev, [w]: (prev[w] || 0) + 1 }));
                         playSound('win', audioCtxRef, soundTheme); FireConfetti(confettiCanvasRef.current);
                         if (newWinners.length < rapidTarget && activeNames.length > 1) {
                             setTimeout(() => { velocityRef.current = 0.5 + Math.random() * 0.5; isSpinningRef.current = true; setIsSpinning(true); }, 800);
                         } else { setWinner("Group Complete!"); }
                         return;
                    }

                    if (battleMode && battleStage === 'spinning2' && w === battleContestants[0]) { velocityRef.current = 0.05 + Math.random() * 0.05; af = requestAnimationFrame(animate); return; }

                    if (battleMode) {
                        if (battleStage === 'spinning1') { setBattleContestants([w, null]);
                        setBattleStage('waiting'); if (soundEnabled) playSound('tick', audioCtxRef, soundTheme); setTimeout(() => { setBattleStage('spinning2'); velocityRef.current = 0.4 + Math.random() * 0.4; isSpinningRef.current = true; setIsSpinning(true); }, 1000);
                        } else if (battleStage === 'spinning2') { setBattleContestants(prev => [prev[0], w]);
                        setBattleStage('finished'); if (soundEnabled) playSound('win', audioCtxRef, soundTheme); FireConfetti(confettiCanvasRef.current); }
                    } else if (w) {
                        setWinner(w); if (bw) setBloomWinner(bw);
                        if (bloomMode !== 'solo') { 
                            const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            setWinnerHistory(p => [{name: w, time: ts}, ...p].slice(0, 10)); 
                            if (fairMode && !hiddenNames.includes(w)) { setHiddenNames(prev => [...prev, w]); }
                            setParticipation(prev => ({ ...prev, [w]: (prev[w] || 0) + 1 }));
                        }
                        if (soundEnabled) playSound('win', audioCtxRef, soundTheme);
                        setTimeout(() => FireConfetti(confettiCanvasRef.current), 10);
                    }
                } else af = requestAnimationFrame(animate);
            };
            animate(); return () => cancelAnimationFrame(af);
          }, [isSpinning, activeNames, hiddenNames, soundEnabled, mysteryMode, soundTheme, battleMode, battleStage, battleContestants, bloomMode, concepts, fairMode, rapidMode, rapidTarget, rapidWinners]);

          useEffect(() => { 
              if (!isSpinning) {
const mainList = bloomMode === 'solo' ? concepts : activeNames;

// Always draw the first wheel
drawWheel(canvasRef.current, mainList, rotationRef.current, pointerRef.current, mysteryMode);

// Draw the second wheel ONLY if Name + Concept mode is on
bloomMode === 'dual' && drawWheel(canvasRef2.current, concepts, rotationRef2.current, pointerRef2.current, false);
               }
          }, [names, hiddenNames, currentThemeId, mysteryMode, isSpinning, hubImage, bloomMode, concepts, activeNames]);

useEffect(() => {
              const handleResize = () => {
                  const mainList = bloomMode === 'solo' ? concepts : activeNames;
                  drawWheel(canvasRef.current, mainList, rotationRef.current, pointerRef.current, mysteryMode);
                  if (bloomMode === 'dual') { 
                      drawWheel(canvasRef2.current, concepts, rotationRef2.current, pointerRef2.current, false); 
                  }
              };
              window.addEventListener('resize', handleResize); 
              return () => window.removeEventListener('resize', handleResize);
          }, [bloomMode, concepts, activeNames, mysteryMode]);

          useEffect(() => {
              const k = (e) => {
                  if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
                  if (e.code === 'Space') { 
                      e.preventDefault(); 
                      if (winner) setWinner(null); 
                      else if (battleStage === 'finished') setBattleStage('idle'); 
                      else if (!isSpinning) spin(); 
                  }
                  if (e.code === 'Escape') { 
                      if (winner) setWinner(null); 
                      else if (battleStage === 'finished') setBattleStage('idle'); 
                      else { setShowHelp(false); setShowImport(false); setShowGroups(false); setProjectorMode(false); } 
                  }
                  if (e.key === '1') playSound('correct', audioCtxRef);
                  if (e.key === '2') playSound('wrong', audioCtxRef);
                  if (e.key === '3') playSound('drumroll', audioCtxRef);
              };
              window.addEventListener('keydown', k); return () => window.removeEventListener('keydown', k);
          }, [winner, isSpinning, projectorMode, names, showHelp, showImport, showGroups, battleStage]);

          const cssVariables = {
            '--bg-color': theme.bg, '--text-color': theme.text,
            '--sidebar-bg': theme.sidebar, '--accent-color': theme.accent,
            '--grad-start': theme.colors[0], '--grad-end': theme.colors[1]
          };

          const styles = `
            body { margin: 0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
            
            /* --- ANIMATION KEYFRAMES --- */
            @keyframes slide { 0% { background-position: 0 0; } 100% { background-position: 50px 50px; } }
            @keyframes twinkle { 0% { background-position: 0 0; } 100% { background-position: -100px 50px; } }
            @keyframes pulse { 0% { background-size: 30px 30px; } 50% { background-size: 35px 35px; } 100% { background-size: 30px 30px; } }
            @keyframes scroll { 0% { background-position: 0 0; } 100% { background-position: 0 120px; } }
            @keyframes float { 0% { background-position: 0 0; } 50% { background-position: 20px 20px; } 100% { background-position: 0 0; } }
            @keyframes modalPop { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

            .app { 
                display: flex;
                height: 100vh; height: 100dvh;
                font-family: 'Segoe UI', system-ui, sans-serif; 
                background-color: var(--bg-color); color: var(--text-color); 
                transition: all 0.5s ease; user-select: none; 
                background-image: ${theme.pattern || 'none'}, ${theme.grad || 'none'}; 
                background-size: ${theme.bgSize || 'auto'}, cover;
                background-attachment: fixed, fixed;
                animation: ${theme.anim === 'slide' ? 'slide 4s linear infinite' : 
                             theme.anim === 'twinkle' ? 'twinkle 60s linear infinite' : 
                             theme.anim === 'pulse' ? 'pulse 10s ease-in-out infinite' : 
                             theme.anim === 'scroll' ? 'scroll 3s linear infinite' :
                             theme.anim === 'float' ? 'float 20s ease-in-out infinite' : 'none'};
            }

/* --- UPDATED SIDE-BY-SIDE LOGIC --- */
.sidebar { 
                width: 340px; 
                flex-shrink: 0;
                background: var(--sidebar-bg);
                backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
                border-right: 1px solid rgba(255,255,255,0.1); 
                display: flex; flex-direction: column; 
                z-index: 45; 
                /* Transition margin instead of transform for the push effect */
                transition: margin-left 0.5s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.5s ease;
            }

            .sidebar.closed { 
                margin-left: -340px; 
                opacity: 0; 
                pointer-events: none; /* Prevents invisible clicks */
            }

            .sidebar.open { 
                margin-left: 0; 
                opacity: 1; 
            }

.main { 
                flex: 1; 
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                position: relative; 
                padding: 10px; 
                overflow: hidden; 
                height: 100vh;
                min-width: 0; /* This is the secret for side-by-side resizing */
            }

            /* Adjust for smaller tablets/phones */
            @media (max-width: 1024px) {
                .sidebar { width: 300px; }
                .sidebar.closed { margin-left: -300px; }
                .modal { width: 95%; padding: 20px; }
                .modal { 
        width: 95%; 
        height: 90vh; /* Takes up most of the height on phones */
        padding: 0; 
        border-radius: 20px; 
    }
    /* Makes buttons easier to tap on iPad/iPhone */
    .btn { padding: 12px; }
            }

            .btn { 
                background: rgba(255, 255, 255, 0.05); 
                border: 1px solid rgba(255, 255, 255, 0.1); 
                cursor: pointer; color: inherit; display: flex; align-items: center; gap: 8px; padding: 10px; 
                border-radius: 12px; font-weight: 600; font-size: 0.9rem; 
                transition: all 0.2s ease;
                backdrop-filter: blur(5px);
            }
            .btn:hover { 
                background: rgba(255, 255, 255, 0.15); 
                border-color: rgba(255, 255, 255, 0.3);
                transform: translateY(-1px);
                box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
            }
            .btn:active { transform: scale(0.98); }
            .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
            
            .btn-primary { 
                background: linear-gradient(135deg, var(--accent-color), var(--grad-end)); 
                color: #fff; border: none;
                padding: 20px 50px; font-size: 1.6rem; border-radius: 60px; 
                box-shadow: 0 10px 30px -10px var(--accent-color); 
                white-space: nowrap; z-index: 10; margin-bottom: 20px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            .btn-primary:hover:not(:disabled) { 
                filter: brightness(1.1); transform: translateY(-3px) scale(1.02); 
                box-shadow: 0 20px 40px -10px var(--accent-color);
            }

            .input-area { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; }
            .textarea { 
                width: 100%; min-height: 150px; 
                background: rgba(0, 0, 0, 0.2); 
                border: 1px solid rgba(255, 255, 255, 0.1); 
                color: inherit; padding: 16px; border-radius: 16px; 
                resize: vertical; font-family: monospace; outline: none; font-size: 16px; 
                transition: all 0.3s;
            }
            .textarea:focus { 
                background: rgba(0, 0, 0, 0.3); 
                border-color: var(--accent-color); 
                box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1); 
            }

            .modal-overlay { 
                position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
                backdrop-filter: blur(8px);
                display: flex; align-items: center; justify-content: center; z-index: 50; padding: 20px; 
            }
            .modal { 
                background: rgba(15, 23, 42, 0.85); 
                backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                padding: 40px; border-radius: 32px; text-align: center; 
                max-width: 450px; width: 100%; 
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
                border: 1px solid rgba(255, 255, 255, 0.1);
                max-height: 90vh; overflow-y: auto; 
                animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            .winner-name { 
                font-size: clamp(2.5rem, 6vw, 4rem); font-weight: 900; margin: 20px 0; 
                background: linear-gradient(135deg, #fff 0%, var(--accent-color) 100%); 
                -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
                filter: drop-shadow(0 0 30px var(--accent-color));
                line-height: 1.1; 
            }

            .section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.6; margin-bottom: 10px; display: block; font-weight: 800; color: var(--accent-color); }
            
            .chip { 
                font-size: 0.85rem; padding: 6px 12px; border-radius: 8px; cursor: pointer; 
                background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
                transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; 
            }
            .chip:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); transform: translateY(-1px); }
            .chip.hidden { opacity: 0.4; text-decoration: line-through; background: transparent; border-color: transparent; }

            .projector-btn { position: absolute; top: 20px; right: 20px; z-index: 30; }
            .mobile-toggle { position: absolute; top: 20px; left: 20px; z-index: 30; }
            .wheel-container { flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; min-height: 0; flex-shrink: 1; }

@media (max-width: 1024px) {
    .sidebar { 
        width: 280px; 
        position: fixed; 
        height: 100%; 
        top: 0; 
        left: 0; 
    }
    .sidebar.closed { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .modal { width: 95%; padding: 20px; border-radius: 20px; }
}
          `;

          return (
            <div className="app" style={cssVariables}>
                <style>{styles}</style>
                <canvas ref={confettiCanvasRef} style={{position: 'fixed', inset: 0, pointerEvents: 'none', zIndex: 50}} />
                <button onClick={() => setShowSettings(true)} className="mobile-toggle btn"><Icons.Settings /></button>

<div className={`sidebar ${showSettings ? 'open' : 'closed'} ${projectorMode ? 'projector-hidden' : ''}`}>
<div style={{padding: '16px 20px', display: 'flex', flexDirection: 'column', gap: 12, borderBottom: '1px solid rgba(255,255,255,0.05)'}}>
         <div style={{display:'flex', justifyContent: 'space-between', alignItems:'center'}}>
            <div style={{display: 'flex', flexDirection: 'column'}}>
                <h1 style={{margin:0, fontSize: '1.2rem', fontWeight:900, background: `linear-gradient(to right, ${theme.accent}, ${theme.colors[2]})`, WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'}}>
                    Swiss Army Spinner
                </h1>
                <span style={{fontSize: '0.65rem', opacity: 0.5, textTransform: 'uppercase', letterSpacing: 1}}>Teacher Toolkit</span>
            </div>
            <button className="btn" onClick={() => setShowSettings(false)} style={{padding: 6, border:'none', background:'rgba(239,68,68,0.1)', color:'#ef4444'}} title="Hide Settings"><Icons.X /></button>
         </div>
         {/* Mute and Celebrate Row */}
         <div style={{display:'flex', gap: 6}}>
            <button className="btn" onClick={() => setSoundEnabled(!soundEnabled)} style={{flex: 1, justifyContent: 'center', background: soundEnabled ? 'rgba(255,255,255,0.05)' : 'rgba(239,68,68,0.2)', color: soundEnabled ? 'inherit' : '#ef4444'}}>
                {soundEnabled ? <Icons.Volume2 /> : <Icons.VolumeX />} {soundEnabled ? "Audio On" : "Muted"}
            </button>
            <button className="btn" onClick={() => FireConfetti(confettiCanvasRef.current)} style={{flex: 1, justifyContent: 'center', background: 'rgba(139, 92, 246, 0.1)', color: '#8b5cf6'}}>ðŸŽ‰ Celebrate</button>
         </div>
         <div style={{display:'flex', gap: 6}}>
            <button className="btn" onClick={() => setShowHelp(true)} style={{flex: 1, justifyContent: 'center', fontSize: '0.8rem'}}><Icons.HelpCircle /> Guide</button>
            <button className="btn" onClick={toggleFullScreen} style={{flex: 1, justifyContent: 'center', fontSize: '0.8rem'}}><Icons.Maximize /> Projector</button>
         </div>
    </div>
                    
                    <div className="input-area">
                        {/* THEME PICKER */}
                        <div style={{marginBottom: 20}}>
                            <span className="section-title"><Icons.Palette/> Theme</span>
                            <div style={{display:'flex', gap: 8, overflowX:'auto', paddingBottom: 4}}>
                                {Object.keys(THEMES).map(key => (
                                    <button 
                                        key={key}
                                        onClick={() => setCurrentThemeId(key)}
                                        style={{
                                            width: 30, height: 30, borderRadius: '50%', flexShrink: 0,
                                            background: THEMES[key].grad,
                                            border: currentThemeId === key ? '2px solid white' : '2px solid rgba(255,255,255,0.2)',
                                            boxShadow: currentThemeId === key ? `0 0 10px ${THEMES[key].accent}` : 'none',
                                            cursor: 'pointer', transition: 'all 0.2s'
                                        }}
                                        title={THEMES[key].name}
                                    />
                                ))}
                            </div>
                            <div style={{fontSize:'0.8rem', marginTop:4, opacity:0.7, textAlign:'right'}}>{theme.name}</div>
                        </div>

                        {/* CLASS MANAGER */}
                        <div>
                            <div style={{display:'flex', gap:4}}>
                                <input value={newListName} onChange={(e) => setNewListName(e.target.value)} className="btn" style={{flex:1, cursor:'text', background:'rgba(255,255,255,0.05)', textAlign:'left'}} placeholder="Class Name..." />
                                <button onClick={saveList} className="btn" style={{background: 'rgba(16, 185, 129, 0.2)', color: '#10b981'}} title="Save Session (Names, Marbles, Stickies, etc.)"><Icons.Save /></button>
                            </div>
                            {Object.keys(savedLists).length > 0 && (
                                <div style={{marginTop: 12, display: 'flex', flexDirection: 'column', gap: 6, maxHeight: 150, overflowY: 'auto', paddingRight: 4}}>
                                    <div style={{fontSize: '0.75rem', opacity: 0.5, textTransform: 'uppercase', letterSpacing: 1, fontWeight: 700, marginBottom: 4}}>Saved Sessions</div>
                                    {Object.keys(savedLists).map(key => (
                                        <div key={key} style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: 'rgba(128,128,128,0.1)', padding: '4px', borderRadius: 6, border: '1px solid rgba(128,128,128,0.1)', position: 'relative'}}>
                                            <div onClick={() => handleLoadClass(key)} style={{flex: 1, cursor: 'pointer', padding: '6px 8px', borderRadius: 4, fontWeight: 600, fontSize: '0.85rem', display:'flex', alignItems:'center', gap: 8, transition: '0.2s'}} onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.05)'} onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'} title="Load this class">
                                                <div style={{width: 8, height: 8, borderRadius: '50%', background: theme.accent}}></div>
                                                <div style={{display:'flex', flexDirection:'column'}}><span>{key}</span><span style={{fontSize:'0.7rem', opacity:0.6, fontWeight:400}}>{Array.isArray(savedLists[key]) ? `${savedLists[key].length} students` : `${savedLists[key].names.length} students`}</span></div>
                                            </div>
                                            <button onClick={(e) => handleDeleteClass(e, key)} className="btn" style={{background: 'rgba(239, 68, 68, 0.15)', color: '#ef4444', padding: 0, height: 32, width: 32, justifyContent:'center', borderRadius: 6, border: '1px solid rgba(239, 68, 68, 0.2)', marginLeft: 4, zIndex: 20, position: 'relative', cursor: 'pointer'}} title="Delete Class" type="button"><Icons.Trash /></button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        
                        <div style={{marginTop: 20, display: 'flex', flexDirection: 'column'}}> 
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span className="section-title">Names ({activeNames.length}/{names.length})</span>
                                <div style={{display:'flex', gap:4}}>
                                    <button onClick={() => setShowImport(true)} className="btn" style={{padding:'2px 6px', fontSize:'0.7rem', background: 'rgba(128,128,128,0.1)'}} title="Import List"><Icons.Clipboard /> Import</button>
                                    <button onClick={() => setShowHeatmap(!showHeatmap)} className="btn" style={{padding:'2px 6px', fontSize:'0.7rem', background: showHeatmap ? theme.accent : 'rgba(128,128,128,0.1)'}}><Icons.BarChart /> {showHeatmap ? 'Editor' : 'Heatmap'}</button>
                                    {(hiddenNames.length > 0 || Object.keys(participation).length > 0) && (<button onClick={() => {setHiddenNames([]); setParticipation({})}} style={{fontSize:'0.7rem', color: '#ef4444', background:'none', border:'none', cursor:'pointer'}}><Icons.Refresh /> Reset</button>)}
                                 </div>
                            </div>
                            {showHeatmap ? (
                                <div style={{height: 120, minHeight: 100, overflowY:'auto', background:'rgba(0,0,0,0.2)', borderRadius:8, padding:8, marginTop: 8}}>
                                    {names.map(n => {
                                        const count = participation[n] || 0;
                                        let color = '#10b981'; if(count === 1) color = '#f59e0b'; if(count >= 2) color = '#ef4444'; 
                                        return (
                                            <div key={n} style={{display:'flex', justifyContent:'space-between', fontSize:'0.9rem', marginBottom:4, borderBottom:'1px solid rgba(255,255,255,0.05)', paddingBottom:2}}>
                                                <span>{n}</span><span style={{background:color, color:'white', borderRadius:'10px', padding:'0 6px', fontSize:'0.75rem', fontWeight:'bold'}}>{count}</span>
                                            </div>
                                        )
                                    })}
                                    <button onClick={exportCSV} className="btn" style={{fontSize:'0.7rem', padding:'2px 6px', background:'rgba(128,128,128,0.1)', width: '100%', marginTop: 8, justifyContent:'center'}}><Icons.Save /> Export CSV</button>
                                </div>
                            ) : (
                                <textarea value={inputText} onChange={(e) => updateNames(e.target.value)} className="textarea" placeholder="Enter names..." />
                            )}
                            {!showHeatmap && (<div style={{display:'flex', flexWrap:'wrap', gap: 4, marginTop: 8}}>{names.slice(0, 50).map((n, i) => (<div key={i} onClick={() => toggleHidden(n)} className={`chip ${hiddenNames.includes(n) ? 'hidden' : ''}`} title="Click to hide/show">{n}</div>))}</div>)}
                        </div>

                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap: 8}}>
                            <button onClick={shuffleNames} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}><Icons.Shuffle/> Shuffle</button>
                            <button onClick={() => setMysteryMode(!mysteryMode)} className="btn" style={{background: mysteryMode ? theme.accent : 'rgba(128,128,128,0.1)', color: mysteryMode ? '#fff' : 'inherit', boxShadow: mysteryMode ? `0 0 10px ${theme.accent}` : 'none', transition: 'all 0.3s ease'}}>{mysteryMode ? <Icons.EyeOff/> : <Icons.Eye/>} {mysteryMode ? 'Mystery On' : 'Visible'}</button>
                            
                            <button onClick={() => {setBattleMode(!battleMode); setBloomMode('off'); setBattleStage('idle'); setRapidMode(false);}} className="btn" style={{background: battleMode ? '#f59e0b' : 'rgba(128,128,128,0.1)', color: battleMode ? '#fff' : 'inherit', boxShadow: battleMode ? '0 0 10px #f59e0b' : 'none'}}><Icons.Swords/> Battle</button>
                            <button onClick={() => setFairMode(!fairMode)} className="btn" style={{background: fairMode ? '#10b981' : 'rgba(128,128,128,0.1)', color: fairMode ? '#fff' : 'inherit', boxShadow: fairMode ? '0 0 10px #10b981' : 'none'}}><Icons.Scales/> Fair Mode</button>

                            <button onClick={() => setShowNoiseMeter(!showNoiseMeter)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}>ðŸŽ¤ Noise Meter</button>
                            <button onClick={() => setShowGroups(true)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}><Icons.Users/> Teams</button>
                            
                            <button onClick={() => setShowBrainBreak(!showBrainBreak)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}>âš¡ Strategy</button>
                            <button onClick={() => setShowPoll(!showPoll)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}>ðŸ“Š Poll</button>
                            
                            <button onClick={generateLineup} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}>ðŸ“œ Lineup</button>
                            <button onClick={() => setShowTimer(!showTimer)} className="btn" style={{background: showTimer ? theme.accent : 'rgba(128,128,128,0.1)', color: showTimer ? '#fff' : 'inherit', justifyContent: 'center'}}><Icons.Clock/> {showTimer ? "Hide Timer" : "Timer"}</button>

                            {/* ROW 6: Seating & Marble Jar */}
                            <button onClick={() => setShowSeating(true)} className="btn" style={{background: 'rgba(128,128,128,0.1)', justifyContent:'center'}}>
                                <Icons.Grid/> Seating
                            </button>
                            <button onClick={() => setShowMarbleJar(!showMarbleJar)} className="btn" style={{background: 'rgba(128,128,128,0.1)', justifyContent:'center'}}>
                                <Icons.Jar/> Marble Jar
                            </button>

                            <div style={{display:'flex', gap: 4, gridColumn: 'span 2'}}>
                                <button onClick={toggleBloomMode} className="btn" style={{flex: 1, background: bloomMode !== 'off' ? '#3b82f6' : 'rgba(128,128,128,0.1)', color: bloomMode !== 'off' ? '#fff' : 'inherit', boxShadow: bloomMode !== 'off' ? '0 0 10px #3b82f6' : 'none'}}><Icons.Brain/> {bloomMode === 'solo' ? "Concept Only" : bloomMode === 'dual' ? "Name + Concept" : "Concept Mode"}</button>
                                <button onClick={() => setShowConceptEdit(true)} className="btn" style={{background: 'rgba(128,128,128,0.1)', padding: 10}} title="Edit Concepts"><Icons.Edit/></button>
                            </div>

                            <button onClick={() => setShowTodo(!showTodo)} className="btn" style={{gridColumn: 'span 2', background: showTodo ? theme.accent : 'rgba(128,128,128,0.1)', color: showTodo ? '#fff' : 'inherit', justifyContent: 'center'}}><Icons.Check/> {showTodo ? "Hide Tasks" : "To-Do List"}</button>
                        </div>

                        <div style={{marginTop: 8}}>
                            <span className="section-title">Rapid Fire (Multi-Pick)</span>
                            <div style={{display:'flex', gap: 8}}>
                                <button onClick={() => startRapidFire(3)} disabled={isSpinning || activeNames.length < 3} className="btn" style={{flex:1, background: 'rgba(236, 72, 153, 0.2)', color:'#ec4899', justifyContent:'center'}}>Pick 3</button>
                                <button onClick={() => startRapidFire(5)} disabled={isSpinning || activeNames.length < 5} className="btn" style={{flex:1, background: 'rgba(236, 72, 153, 0.2)', color:'#ec4899', justifyContent:'center'}}>Pick 5</button>
                            </div>
                        </div>
                        
                        <div style={{marginTop: 20}}>
                             <span className="section-title">Chance Tools</span>
                             <div style={{display:'flex', gap: 8}}>
                                 <button onClick={() => runChance('coin')} className="btn" style={{flex:1, background: 'rgba(255,255,255,0.1)', justifyContent:'center'}}>Flip Coin</button>
                                 <button onClick={() => runChance('dice')} className="btn" style={{flex:1, background: 'rgba(255,255,255,0.1)', justifyContent:'center'}}>Roll D6</button>
                                 <button onClick={() => runChance('num')} className="btn" style={{flex:1, background: 'rgba(255,255,255,0.1)', justifyContent:'center'}}>1-10</button>
                             </div>
                        </div>

                        <div style={{marginTop: 20}}>
                             {trafficMode === 'sidebar' ? (
                                 <div style={{display:'flex', gap:8}}>
                                     <div style={{flex: 1, display:'flex', justifyContent:'space-evenly', background:'rgba(0,0,0,0.2)', padding: '12px 0', borderRadius: 12, border:'1px solid rgba(255,255,255,0.05)'}}>
                                         {['red', 'yellow', 'green'].map(color => (
                                             <button key={color} onClick={() => setTrafficLight(color)} style={{width: 40, height: 40, borderRadius: '50%', cursor: 'pointer', border: '3px solid rgba(255,255,255,0.15)', background: color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e', opacity: trafficLight === color ? 1 : 0.25, transform: trafficLight === color ? 'scale(1.15)' : 'scale(1)', boxShadow: trafficLight === color ? `0 0 20px ${color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e'}` : 'none', transition: 'all 0.3s ease'}} />
                                         ))}
                                     </div>
                                     <button onClick={() => setTrafficMode('floating')} className="btn" style={{width: 50, justifyContent:'center', background:'rgba(255,255,255,0.1)'}} title="Project to Screen"><Icons.Maximize/></button>
                                 </div>
                             ) : (
                                 <button onClick={() => setTrafficMode('sidebar')} className="btn" style={{width:'100%', justifyContent:'center', background:'rgba(34,197,94,0.15)', color:'#4ade80', padding: 16, border:'1px dashed rgba(34,197,94,0.3)'}}><Icons.ArrowDown/> Active on Screen (Click to Return)</button>
                             )}
                        </div>

                        <div style={{marginTop: 20}}>
                             <span className="section-title">Big Message (Billboard)</span>
                             <div style={{display:'flex', gap:8}}>
                                 <input value={billboardText} onChange={(e) => setBillboardText(e.target.value)} placeholder="Ex: Turn to page 42..." style={{flex:1, padding: 8, borderRadius: 6, border: '1px solid rgba(128,128,128,0.2)', background:'transparent', color:'inherit'}} />
                                 <button onClick={() => setShowBillboard(!showBillboard)} className="btn" style={{background: showBillboard ? theme.accent : 'rgba(255,255,255,0.1)', width: 45, justifyContent:'center'}} title={showBillboard ? "Hide Message" : "Project Message"}>{showBillboard ? <Icons.EyeOff/> : <Icons.Maximize/>}</button>
                             </div>
                        </div>

                        <div style={{marginTop: 20}}>
                             <button onClick={addSticky} className="btn" style={{width:'100%', justifyContent:'center', background:'#fcd34d', color:'#78350f', fontWeight:'bold', boxShadow:'0 4px 0 #b45309'}}>+ Add Sticky Note</button>
                        </div>

                        <div style={{marginTop: 20}}>
                             <span className="section-title">Quick Notes (Auto-Saved)</span>
                             <textarea value={scratchpad} onChange={(e) => setScratchpad(e.target.value)} className="textarea" placeholder="Jot down reminders, homework, or ideas here..." style={{minHeight: 80, fontSize:'0.85rem', background:'rgba(255,255,255,0.05)', border:'1px solid rgba(255,255,255,0.1)'}}/>
                        </div>

                        <div style={{marginTop: 20}}>
                             <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 8}}><span className="section-title">Game Show FX (Hotkeys: 1, 2, 3)</span></div>
                             <div style={{display:'flex', gap: 4}}>
                                 <button onClick={() => playSound('correct', audioCtxRef)} className="btn" style={{flex: 1, background:'#22c55e', color:'white', justifyContent:'center', padding: 8}} title="Correct Answer"><Icons.ThumbsUp /></button>
                                 <button onClick={() => playSound('wrong', audioCtxRef)} className="btn" style={{flex: 1, background:'#ef4444', color:'white', justifyContent:'center', padding: 8}} title="Wrong Answer"><Icons.ThumbsDown /></button>
                                 <button onClick={() => playSound('drumroll', audioCtxRef)} className="btn" style={{flex: 1, background:'#f59e0b', color:'white', justifyContent:'center', padding: 8}} title="Drumroll"><Icons.Zap /></button>
                             </div>
                        </div>
                        
                        <div style={{marginTop: 20}}>
                              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 8}}><span className="section-title">Session History</span>{winnerHistory.length > 0 && <button onClick={() => setWinnerHistory([])} style={{fontSize: '0.7rem', color: '#ef4444', background: 'none', border:'none', cursor:'pointer'}}>Clear</button>}</div>
                             <div style={{maxHeight: 120, overflowY: 'auto', background: 'rgba(128,128,128,0.05)', borderRadius: 8, padding: 8}}>{winnerHistory.length === 0 && <div style={{fontSize: '0.8rem', opacity: 0.5, fontStyle: 'italic', textAlign: 'center'}}>No winners yet.</div>}{winnerHistory.map((item, i) => (<div key={i} style={{fontSize: '0.85rem', display:'flex', justifyContent:'space-between', padding:'4px 0', borderBottom: '1px solid rgba(128,128,128,0.1)'}}><span>{item.name}</span><span style={{opacity: 0.5, fontSize: '0.75rem'}}>{item.time}</span></div>))}</div>
                        </div>
                    </div>
                </div>

                <div className="main">
                    {showBillboard && (
                        <DraggableBox x={50} y={50} style={{zIndex: 55}}>
                            <div style={{background: 'rgba(15, 23, 42, 0.9)', padding: '30px 40px', borderRadius: 20, border: '2px solid rgba(255,255,255,0.1)', backdropFilter: 'blur(10px)', boxShadow: '0 20px 50px rgba(0,0,0,0.5)', minWidth: '300px', maxWidth: '80vw', textAlign: 'center', position: 'relative', resize: 'both', overflow: 'hidden'}}>
                                <button onClick={() => setShowBillboard(false)} style={{position: 'absolute', top: 10, right: 10, background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', fontWeight: 'bold', fontSize: '1.2rem'}} title="Close Billboard"><Icons.X /></button>
                                <div style={{fontSize: 'clamp(2rem, 5vw, 4rem)', fontWeight: 800, lineHeight: 1.2, whiteSpace: 'pre-wrap'}}>
                                {billboardMode === 'qr' ? (<div style={{display:'flex', flexDirection:'column', alignItems:'center', gap:10}}><img src={`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(billboardText || "https://google.com")}`} alt="QR Code" style={{borderRadius: 8, border: '4px solid white'}}/><div style={{fontSize:'1rem', opacity:0.8, wordBreak:'break-all', maxWidth: 300}}>{billboardText}</div></div>) : (<div style={{fontSize: 'clamp(2rem, 5vw, 4rem)', fontWeight: 800, lineHeight: 1.2, whiteSpace: 'pre-wrap'}}>{billboardText || "Class Message"}</div>)}
                                </div>
                            </div>
                        </DraggableBox>
                    )}

                    {stickies.map(note => (
                        <DraggableBox key={note.id} x={note.x} y={note.y} style={{zIndex: 56}}>
                            <div style={{width: 200, minHeight: 200, background: note.color, boxShadow: '5px 5px 15px rgba(0,0,0,0.3)', transform: `rotate(${note.rotation}deg)`, padding: 12, borderRadius: 2, display: 'flex', flexDirection: 'column', position: 'relative', resize: 'both', overflow: 'hidden'}}>
                                <button onClick={() => deleteSticky(note.id)} style={{position: 'absolute', top: 5, right: 5, color: '#000', opacity: 0.4, border: 'none', background: 'none', cursor: 'pointer', fontWeight: 'bold', zIndex: 10}} title="Delete Note"><Icons.X /></button>
                                <textarea value={note.text} onChange={(e) => updateSticky(note.id, e.target.value)} placeholder="Type note..." style={{flex: 1, width: '100%', height: '100%', background: 'transparent', border: 'none', outline: 'none', resize: 'none', color: '#333', fontFamily: '"Comic Sans MS", "Marker Felt", sans-serif', fontSize: '1.1rem', lineHeight: 1.4, marginTop: 14}} />
                                <div style={{position:'absolute', bottom: 2, right: 2, width: 12, height: 12, pointerEvents:'none', borderBottom: '2px solid rgba(0,0,0,0.1)', borderRight: '2px solid rgba(0,0,0,0.1)'}}/>
                            </div>
                        </DraggableBox>
                    ))}

                    {/* SEATING CHART */}
                    {showSeating && <SeatingChart names={activeNames} onClose={() => setShowSeating(false)} />}

                    {/* MARBLE JAR WIDGET */}
{showMarbleJar && <MarbleJar audioCtx={audioCtxRef} names={activeNames} onClose={() => setShowMarbleJar(false)} marbles={marbles} setMarbles={setMarbles} target={marbleTarget} setTarget={setMarbleTarget} reward={marbleReward} setReward={setMarbleReward} />}                    
                    {/* KAGAN STRATEGY WIDGET */}
                    {showBrainBreak && (
                        breakView === 'full' ? (
                            <div style={{position:'fixed', inset:0, zIndex:100, background:'linear-gradient(135deg, #7c3aed, #4c1d95)', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', padding:40, textAlign:'center'}}>
                                <button onClick={()=>setBreakView('window')} style={{position:'absolute', top:20, right:20, background:'rgba(255,255,255,0.2)', border:'none', color:'white', padding:15, borderRadius:'50%', cursor:'pointer'}}><Icons.Minimize/></button>
                                <div style={{fontSize:'8rem', marginBottom:20}}>{currentBreak.icon}</div>
                                <h1 style={{fontSize:'5rem', fontWeight:900, margin:0, color:'white', marginBottom:30}}>{currentBreak.title}</h1>
                                <div style={{fontSize:'2.5rem', maxWidth:1000, lineHeight:1.4, background:'rgba(255,255,255,0.1)', padding:40, borderRadius:30}}>{currentBreak.desc}</div>
                                <button onClick={pickBrainBreak} className="btn" style={{marginTop:40, background:'white', color:'#7c3aed', fontSize:'2rem', padding:'20px 60px', borderRadius:50, fontWeight:800}}><Icons.Shuffle/> New Strategy</button>
                            </div>
                        ) : breakView === 'mini' ? (
                            <DraggableBox x={100} y={150} style={{zIndex: 55}}>
                                <div style={{background: '#8b5cf6', color:'white', padding:'8px 16px', borderRadius:30, display:'flex', alignItems:'center', gap:10, boxShadow:'0 10px 30px rgba(0,0,0,0.3)', border:'2px solid rgba(255,255,255,0.2)'}}>
                                    <span style={{fontSize:'1.2rem'}}>{currentBreak.icon}</span><span style={{fontWeight:700}}>{currentBreak.title}</span><button onClick={()=>setBreakView('window')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button>
                                </div>
                            </DraggableBox>
                        ) : (
                            <DraggableBox x={100} y={150} style={{zIndex: 55}}>
                                <div style={{background: 'linear-gradient(135deg, #8b5cf6, #6d28d9)', borderRadius: 16, width: 320, textAlign: 'center', boxShadow: '0 15px 40px rgba(0,0,0,0.5)', border: '1px solid rgba(255,255,255,0.2)', overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                                    <div style={{padding: '12px 16px', background:'rgba(0,0,0,0.2)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                        <span style={{fontWeight:800, color:'white', textTransform:'uppercase', fontSize:'0.9rem'}}>âš¡ Strategy</span>
                                        <div style={{display:'flex', gap:4}}><button onClick={() => setBreakView('full')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button><button onClick={() => setBreakView('mini')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Minimize/></button><button onClick={() => setShowBrainBreak(false)} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.X/></button></div>
                                    </div>
                                    <div style={{padding: 20, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                                        <div style={{fontSize: '4rem', marginBottom: 10, transform: breakAnim ? 'scale(1.2) rotate(10deg)' : 'scale(1)', transition: 'transform 0.1s'}}>{currentBreak.icon}</div>
                                        <div style={{fontSize:'1.4rem', fontWeight:800, color:'white', marginBottom:12}}>{currentBreak.title}</div>
                                        <div style={{background:'rgba(255,255,255,0.1)', padding: 12, borderRadius: 8, width: '100%', fontSize: '0.9rem', color: 'rgba(255,255,255,0.9)', textAlign: 'left', whiteSpace: 'pre-line'}}>{currentBreak.desc}</div>
                                    </div>
                                    <div style={{padding: 16, paddingTop: 0}}><button onClick={pickBrainBreak} className="btn" disabled={breakAnim} style={{width:'100%', justifyContent:'center', background:'white', color:'#6d28d9', fontWeight:800, padding: 12, borderRadius: 10, opacity: breakAnim ? 0.7 : 1}}><Icons.Shuffle/> {breakAnim ? "Spinning..." : "New Activity"}</button></div>
                                </div>
                            </DraggableBox>
                        )
                    )}

                    {/* QUICK POLL WIDGET */}
                    {showPoll && (
                        pollView === 'full' ? (
                            <div style={{position:'fixed', inset:0, zIndex:100, background:'rgba(15,23,42,0.98)', display:'flex', flexDirection:'column', padding:40}}>
                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:40}}>
                                    <h1 style={{fontSize:'3rem', fontWeight:800, color:'#94a3b8', margin:0}}>LIVE POLL</h1>
                                    <div style={{display:'flex', gap:20}}><button onClick={()=>setPollView('window')} className="btn" style={{fontSize:'1.5rem', padding:'10px 20px', background:'rgba(255,255,255,0.1)'}}><Icons.Minimize/> Window</button><button onClick={()=>setShowPoll(false)} className="btn" style={{fontSize:'1.5rem', padding:'10px 20px', background:'rgba(239,68,68,0.2)', color:'#ef4444'}}><Icons.X/></button></div>
                                </div>
                                <div style={{display:'flex', gap:40, flex:1, alignItems:'flex-end', justifyContent:'center', paddingBottom:50}}>
                                    {['A','B','C','D'].map((opt, i) => {
                                        const max = Math.max(...Object.values(pollCounts), 1);
                                        const h = (pollCounts[opt] / max) * 100;
                                        const color = i===0?'#ef4444':i===1?'#3b82f6':i===2?'#eab308':'#22c55e';
                                        return (
                                            <div key={opt} style={{flex:1, height:'100%', display:'flex', flexDirection:'column', justifyContent:'flex-end', alignItems:'center'}}>
                                                <div style={{fontSize:'4rem', fontWeight:900, marginBottom:20, color:'white'}}>{pollCounts[opt]}</div>
                                                <div style={{width:'100%', height:`${Math.max(h, 2)}%`, background:color, borderRadius:'20px 20px 0 0', transition:'height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)', opacity:0.8}}></div>
                                                <div style={{fontSize:'3rem', fontWeight:900, marginTop:20, color:color}}>{opt}</div>
                                                <div style={{display:'flex', gap:10, marginTop:20}}><button onClick={() => updatePoll(opt, 1)} style={{width:60, height:60, fontSize:'2rem', borderRadius:10, border:'none', background:'rgba(255,255,255,0.1)', color:'white', cursor:'pointer'}}>+</button><button onClick={() => updatePoll(opt, -1)} style={{width:60, height:60, fontSize:'2rem', borderRadius:10, border:'none', background:'rgba(255,255,255,0.05)', color:'#94a3b8', cursor:'pointer'}}>-</button></div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : pollView === 'mini' ? (
                            <DraggableBox x={150} y={250} style={{zIndex: 55}}>
                                <div style={{background: '#334155', padding:'8px 16px', borderRadius:30, display:'flex', alignItems:'center', gap:15, border:'1px solid rgba(255,255,255,0.1)'}}>
                                    <span style={{fontWeight:800, color:'white'}}>POLL</span>
                                    <div style={{display:'flex', gap:8, fontSize:'0.9rem', fontWeight:700}}><span style={{color:'#ef4444'}}>A:{pollCounts.A}</span><span style={{color:'#3b82f6'}}>B:{pollCounts.B}</span><span style={{color:'#eab308'}}>C:{pollCounts.C}</span><span style={{color:'#22c55e'}}>D:{pollCounts.D}</span></div>
                                    <button onClick={()=>setPollView('window')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button>
                                </div>
                            </DraggableBox>
                        ) : (
                            <DraggableBox x={150} y={250} style={{zIndex: 55}}>
                                <div style={{background: 'rgba(15, 23, 42, 0.95)', backdropFilter: 'blur(10px)', padding: 16, borderRadius: 16, width: 280, boxShadow: '0 10px 30px rgba(0,0,0,0.4)', border: '1px solid rgba(255,255,255,0.1)'}}>
                                    <div style={{display:'flex',justifyContent:'space-between', marginBottom:15, alignItems:'center'}}>
                                        <span style={{fontWeight:800, color:'#94a3b8', textTransform:'uppercase', fontSize:'0.8rem'}}>Class Vote</span>
                                        <div style={{display:'flex', gap:8}}><button onClick={() => setPollCounts({A:0,B:0,C:0,D:0})} style={{fontSize:'0.7rem', color:'#94a3b8', background:'none', border:'none', cursor:'pointer'}}>Reset</button><button onClick={() => setPollView('full')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button><button onClick={() => setPollView('mini')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Minimize/></button><button onClick={() => setShowPoll(false)} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.X/></button></div>
                                    </div>
                                    <div style={{display:'flex', gap:12, justifyContent:'space-between'}}>
                                        {['A','B','C','D'].map((opt, i) => (
                                            <div key={opt} style={{display:'flex', flexDirection:'column', alignItems:'center', gap:6, flex:1}}>
                                                <div style={{fontWeight:800, color: i===0?'#ef4444':i===1?'#3b82f6':i===2?'#eab308':'#22c55e'}}>{opt}</div>
                                                <div style={{fontSize:'1.5rem', fontWeight:800}}>{pollCounts[opt]}</div>
                                                <div style={{display:'flex', flexDirection:'column', gap:4, width:'100%'}}><button onClick={() => updatePoll(opt, 1)} style={{background:'rgba(255,255,255,0.1)', border:'none', color:'white', borderRadius:4, cursor:'pointer', padding:4}}>+</button><button onClick={() => updatePoll(opt, -1)} style={{background:'rgba(255,255,255,0.05)', border:'none', color:'#94a3b8', borderRadius:4, cursor:'pointer', padding:4}}>-</button></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </DraggableBox>
                        )
                    )}

                    {/* NOISE METER WIDGET */}
                    {showNoiseMeter && (
                        meterView === 'full' ? (
                            <div style={{position:'fixed', inset:0, zIndex:100, background:'rgba(15,23,42,0.95)', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center'}}>
                                <div style={{position:'absolute', top:30, right:30, display:'flex', gap:20}}><button onClick={() => setMeterView('window')} className="btn" style={{background:'rgba(255,255,255,0.1)', fontSize:'1.5rem', padding:'15px 30px'}}><Icons.Minimize/> Shrink</button><button onClick={() => setShowNoiseMeter(false)} className="btn" style={{background:'rgba(239,68,68,0.2)', color:'#ef4444', fontSize:'1.5rem', padding:'15px 30px'}}><Icons.X/></button></div>
                                <div style={{height: '60vh', width: '20vw', background: '#334155', borderRadius: 50, position:'relative', overflow:'hidden', border: '8px solid rgba(255,255,255,0.1)', boxShadow:'0 0 100px rgba(0,0,0,0.5)'}}><div style={{position:'absolute', bottom:0, left:0, right:0, height: `${volume}%`, background: volume > 70 ? '#ef4444' : volume > 40 ? '#eab308' : '#22c55e', transition: 'height 0.1s ease-out, background 0.2s', boxShadow: '0 0 50px currentColor'}}/></div>
                                <div style={{fontSize:'4rem', marginTop:40, fontWeight:900, color:'white'}}>{volume}%</div>
                            </div>
                        ) : meterView === 'mini' ? (
                            <DraggableBox x={50} y={150} style={{zIndex: 55}}>
                                <div style={{background: meterActive ? (volume > 50 ? '#ef4444' : '#22c55e') : '#3b82f6', padding:'8px 16px', borderRadius:30, display:'flex', alignItems:'center', gap:10, boxShadow:'0 10px 30px rgba(0,0,0,0.3)', border:'2px solid white'}}>
                                    <button onClick={toggleMic} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}>{meterActive ? <Icons.Pause/> : 'ðŸŽ¤'}</button><button onClick={() => setMeterView('window')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button>
                                </div>
                            </DraggableBox>
                        ) : (
                            <DraggableBox x={50} y={150} style={{zIndex: 55}}>
                                <div style={{background: 'rgba(15, 23, 42, 0.9)', backdropFilter: 'blur(10px)', padding: '20px 10px', borderRadius: 24, width: 100, boxShadow: '0 10px 30px rgba(0,0,0,0.4)', border: '1px solid rgba(255,255,255,0.1)', display: 'flex', flexDirection: 'column', alignItems: 'center'}}>
                                    <div style={{display:'flex', justifyContent:'space-between', width:'100%', marginBottom: 10, padding:'0 4px'}}><button onClick={() => setMeterView('full')} style={{background:'none', border:'none', color:'#94a3b8', cursor:'pointer', padding: 2}} title="Fullscreen"><Icons.Maximize/></button><button onClick={() => setMeterView('mini')} style={{background:'none', border:'none', color:'#94a3b8', cursor:'pointer', padding: 2}} title="Minimize"><Icons.Minimize/></button><button onClick={() => {setShowNoiseMeter(false); if(meterActive) toggleMic();}} style={{background:'none', border:'none', color:'#94a3b8', cursor:'pointer', padding: 2}}><Icons.X/></button></div>
                                    <div style={{height: 200, width: 40, background: '#334155', borderRadius: 20, position:'relative', overflow:'hidden', boxShadow:'inset 0 2px 5px rgba(0,0,0,0.3)', border: '2px solid rgba(255,255,255,0.1)', marginBottom: 15}}>
                                        <div style={{position:'absolute', bottom:0, left:0, right:0, height: `${volume}%`, background: volume > 70 ? '#ef4444' : volume > 40 ? '#eab308' : '#22c55e', transition: 'height 0.1s ease-out, background 0.2s', boxShadow: '0 0 20px currentColor'}}/>
                                        <div style={{position:'absolute', top:'30%', left:0, right:0, height:2, background:'rgba(255,255,255,0.2)'}}></div><div style={{position:'absolute', top:'60%', left:0, right:0, height:2, background:'rgba(255,255,255,0.2)'}}></div>
                                    </div>
                                    <div style={{textAlign:'center'}}><button onClick={toggleMic} className="btn" style={{justifyContent:'center', width: 60, height: 60, borderRadius:'50%', background: meterActive ? '#ef4444' : '#3b82f6', color:'white', boxShadow: '0 4px 10px rgba(0,0,0,0.3)', transition: 'all 0.3s ease', border: 'none'}} title={meterActive ? "Stop Listening" : "Start Listening"}>{meterActive ? <Icons.Pause/> : <div style={{fontSize: '1.5rem'}}>ðŸŽ¤</div>}</button><div style={{marginTop:8, fontSize:'0.7rem', color:'#94a3b8', fontWeight:700, textTransform:'uppercase'}}>{meterActive ? "Listening" : "Start"}</div></div>
                                </div>
                            </DraggableBox>
                        )
                    )}

                    {/* TO-DO LIST WIDGET */}
                    {showTodo && (
                        todoView === 'full' ? (
                            <div style={{position: 'fixed', inset: 0, zIndex: 35, background: 'rgba(15, 23, 42, 0.95)', backdropFilter: 'blur(10px)', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: 20}}>
                                <div style={{width: '100%', maxWidth: 800, height: '80vh', display: 'flex', flexDirection: 'column'}}>
                                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:30}}>
                                        <h2 style={{fontSize:'3rem', fontWeight:800, margin:0, color: theme.accent, display:'flex', alignItems:'center', gap:15}}><Icons.Clipboard/> Agenda</h2>
                                        <div style={{display:'flex', gap:10}}><button onClick={() => setTodoView('window')} className="btn" style={{background:'rgba(255,255,255,0.1)', fontSize:'1.2rem', padding:'10px 20px'}}><Icons.Minimize/> Shrink</button><button onClick={() => setShowTodo(false)} className="btn" style={{background:'rgba(239, 68, 68, 0.2)', color:'#ef4444', padding:'10px 20px'}}><Icons.X/></button></div>
                                    </div>
                                    <div style={{display:'flex', gap:15, marginBottom:30, background:'rgba(255,255,255,0.05)', padding:10, borderRadius:16, border:'1px solid rgba(255,255,255,0.1)'}}>
                                        <input value={todoInput} onChange={(e) => setTodoInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addTodo()} placeholder="Add a new task..." style={{flex:1, background:'transparent', border:'none', padding:'10px 20px', color:'white', outline:'none', fontSize:'1.5rem'}} autoFocus />
                                        <button onClick={addTodo} className="btn" style={{background: theme.accent, padding:'0 30px', fontSize:'2rem', borderRadius:12}}>+</button>
                                    </div>
                                    <div style={{flex: 1, overflowY: 'auto', display:'flex', flexDirection:'column', gap:12}}>
                                        {todoList.map(t => (
                                            <div key={t.id} onClick={() => toggleTodo(t.id)} style={{display:'flex', alignItems:'center', gap:20, background: t.done ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.08)', padding:'20px', borderRadius:16, transition: 'all 0.2s', cursor:'pointer', borderLeft: t.done ? '6px solid #22c55e' : `6px solid ${theme.accent}`}}>
                                                <div style={{width:32, height:32, borderRadius:8, border:`3px solid ${t.done ? '#22c55e' : 'rgba(255,255,255,0.3)'}`, background: t.done ? '#22c55e' : 'transparent', display:'flex', alignItems:'center', justifyContent:'center', color:'white'}}>{t.done && <Icons.Check/>}</div>
                                                <span style={{flex:1, textDecoration: t.done ? 'line-through' : 'none', fontSize:'1.5rem', opacity: t.done ? 0.5 : 1}}>{t.text}</span>
                                                <button onClick={(e) => {e.stopPropagation(); deleteTodo(t.id);}} className="btn" style={{color:'#ef4444', opacity:0.6}}><Icons.Trash/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ) : todoView === 'mini' ? (
                            <DraggableBox x={250} y={150} style={{zIndex: 55}}>
                                <div style={{background: theme.accent, color:'white', padding:'10px 20px', borderRadius:30, display:'flex', alignItems:'center', gap:10, boxShadow:'0 10px 30px rgba(0,0,0,0.3)'}}>
                                    <Icons.Clipboard/> <span style={{fontWeight:700}}>{todoList.filter(t => !t.done).length} Tasks Left</span><div style={{width:1, height:20, background:'rgba(255,255,255,0.3)'}}></div><button onClick={() => setTodoView('window')} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.Maximize/></button>
                                </div>
                            </DraggableBox>
                        ) : (
                            <DraggableBox x={250} y={150} style={{zIndex: 55}}>
                                <div style={{background: 'rgba(15, 23, 42, 0.95)', backdropFilter: 'blur(12px)', width: 320, borderRadius: 20, border: '1px solid rgba(255,255,255,0.1)', boxShadow: '0 20px 50px rgba(0,0,0,0.5)', overflow:'hidden', display:'flex', flexDirection:'column'}}>
                                    <div style={{background: `linear-gradient(to right, ${theme.accent}, ${theme.colors[0]})`, padding: '15px 20px', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                        <span style={{fontWeight:800, color:'white', display:'flex', alignItems:'center', gap:8}}><Icons.Clipboard/> Agenda</span>
                                        <div style={{display:'flex', gap:5}}><button onClick={() => setTodoView('full')} style={{background:'rgba(255,255,255,0.2)', border:'none', borderRadius:4, padding:4, color:'white', cursor:'pointer'}}><Icons.Maximize/></button><button onClick={() => setTodoView('mini')} style={{background:'rgba(255,255,255,0.2)', border:'none', borderRadius:4, padding:4, color:'white', cursor:'pointer'}}><Icons.Minimize/></button><button onClick={() => setShowTodo(false)} style={{background:'rgba(0,0,0,0.2)', border:'none', borderRadius:4, padding:4, color:'white', cursor:'pointer'}}><Icons.X/></button></div>
                                    </div>
                                    <div style={{padding: 10, maxHeight: 300, overflowY: 'auto', display:'flex', flexDirection:'column', gap:6}}>
                                        {todoList.length === 0 && <div style={{opacity:0.4, textAlign:'center', padding:20, fontStyle:'italic'}}>No tasks yet!<br/>Enjoy the quiet.</div>}
                                        {todoList.map(t => (
                                            <div key={t.id} onClick={() => toggleTodo(t.id)} style={{display:'flex', alignItems:'center', gap:10, padding:'10px', background: t.done ? 'rgba(255,255,255,0.03)' : 'rgba(255,255,255,0.08)', borderRadius:8, cursor:'pointer', transition:'0.2s'}}>
                                                <div style={{width:18, height:18, borderRadius:5, border:`2px solid ${t.done ? '#22c55e' : 'rgba(255,255,255,0.4)'}`, background: t.done ? '#22c55e' : 'transparent', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'0.7rem', color:'white'}}>{t.done && <Icons.Check/>}</div>
                                                <span style={{flex:1, fontSize:'0.95rem', textDecoration: t.done ? 'line-through' : 'none', opacity: t.done ? 0.5 : 1}}>{t.text}</span>
                                                <button onClick={(e) => {e.stopPropagation(); deleteTodo(t.id);}} style={{background:'none', border:'none', color:'#ef4444', opacity:0.5, cursor:'pointer'}}><Icons.X/></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div style={{padding: '10px 15px', borderTop:'1px solid rgba(255,255,255,0.1)', display:'flex', gap:8}}>
                                        <input value={todoInput} onChange={(e) => setTodoInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addTodo()} placeholder="New task..." style={{flex:1, background:'transparent', border:'none', color:'white', outline:'none'}} />
                                        <button onClick={addTodo} style={{background: theme.accent, color:'white', border:'none', borderRadius:6, width:28, height:28, cursor:'pointer'}}>+</button>
                                    </div>
                                </div>
                            </DraggableBox>
                        )
                    )}

{projectorMode && <button onClick={toggleFullScreen} className="projector-btn btn" title="Exit Projector Mode"><Icons.Minimize /></button>}                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" style={{ display: 'none' }} />
                    {showTimer && <Timer audioCtx={audioCtxRef} onClose={() => setShowTimer(false)} />}
                    {activeTeams.length > 0 && <Scoreboard teams={activeTeams} scores={teamScores} onUpdateScore={handleUpdateScore} onClose={() => setActiveTeams([])} />}

                    {battleMode && (
                        <>
                            <div style={{position: 'absolute', top: '50%', left: '20px', transform: 'translateY(-50%)', zIndex: 10, transition: 'all 0.5s', opacity: battleContestants[0] ? 1 : 0.3}}>
                                <div style={{background: theme.colors[0], color: 'white', padding: '20px', borderRadius: 16, textAlign: 'center', boxShadow: '0 10px 30px rgba(0,0,0,0.5)', minWidth: 150}}>
                                    <div style={{fontSize: '0.8rem', textTransform: 'uppercase', opacity: 0.8, fontWeight: 700}}>Player 1</div><div style={{fontSize: '1.5rem', fontWeight: 800}}>{battleContestants[0] || "?"}</div>
                                </div>
                            </div>
                            <div style={{position: 'absolute', top: '50%', right: '20px', transform: 'translateY(-50%)', zIndex: 10, transition: 'all 0.5s', opacity: battleContestants[1] ? 1 : 0.3}}>
                                <div style={{background: theme.colors[1], color: 'white', padding: '20px', borderRadius: 16, textAlign: 'center', boxShadow: '0 10px 30px rgba(0,0,0,0.5)', minWidth: 150}}>
                                    <div style={{fontSize: '0.8rem', textTransform: 'uppercase', opacity: 0.8, fontWeight: 700}}>Player 2</div><div style={{fontSize: '1.5rem', fontWeight: 800}}>{battleContestants[1] || "?"}</div>
                                </div>
                            </div>
                        </>
                    )}

<div ref={containerRef} className="wheel-container" style={{ width: '100%', flex: 1, display: 'flex', flexDirection: 'row', alignItems: 'center', justifyContent: 'center', gap: '20px', minHeight: 0 }}>
                        {/* Wheel 1 */}
                        <canvas ref={canvasRef} onClick={spin} style={{ maxWidth: bloomMode === 'dual' ? '45%' : '90%', maxHeight: '75vh', cursor: 'pointer' }}/>
                        
                        {/* Wheel 2 */}
                        {bloomMode === 'dual' && (
                            <canvas ref={canvasRef2} style={{ maxWidth: '45%', maxHeight: '75vh' }}/>
                        )}
                    </div>
                    
                    <button onClick={spin} disabled={isSpinning || (bloomMode !== 'solo' && activeNames.length < 2)} className="btn btn-primary">
                        {isSpinning ? (battleMode ? (battleStage === 'waiting' ? 'NEXT...' : 'SPINNING...') : 'SPINNING...') : (battleMode ? 'BATTLE SPIN!' : 'SPIN!')}
                    </button>
                </div>

                {battleMode && battleStage === 'finished' && (
                      <div className="modal-overlay">
                          <div className="modal" style={{background: 'linear-gradient(135deg, #1e293b, #0f172a)', border: '2px solid rgba(255,255,255,0.1)'}}>
                            <h2 style={{margin: '0 0 20px 0', fontSize: '3rem', fontStyle: 'italic', fontWeight: 900, background: '-webkit-linear-gradient(#fcd34d, #f59e0b)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'}}>VS</h2>
                             <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 20, marginBottom: 30}}>
                                <div style={{textAlign:'center'}}><div style={{fontSize:'2rem', fontWeight:800, color: theme.colors[0]}}>{battleContestants[0]}</div></div>
                                <div style={{width: 2, height: 60, background:'rgba(255,255,255,0.2)'}}></div>
                                 <div style={{textAlign:'center'}}><div style={{fontSize:'2rem', fontWeight:800, color: theme.colors[1]}}>{battleContestants[1]}</div></div>
                            </div>
                            <button onClick={() => setBattleStage('idle')} className="btn btn-primary" style={{width: '100%'}}>New Battle</button>
                          </div>
                      </div>
                )}

                {chanceAnim && (
                    <div className="modal-overlay">
                        <div className="modal" style={{background:'transparent', boxShadow:'none', border:'none', pointerEvents: 'none'}}>
                            {chanceAnim === 'coin' && (
                                <div style={{perspective: 1000, width: 150, height: 150, margin: '0 auto'}}>
                                    <div style={{width:'100%', height:'100%', transformStyle:'preserve-3d', animation: chanceResult === 'HEADS' ? 'flipHeads 2.5s cubic-bezier(0.1, 0.7, 0.6, 1) forwards' : 'flipTails 2.5s cubic-bezier(0.1, 0.7, 0.6, 1) forwards'}}>
                                        <div style={{position:'absolute', width:'100%', height:'100%', backfaceVisibility:'hidden', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', borderRadius:'50%', border:'8px solid #cbd5e1', background:'radial-gradient(circle, #f8fafc, #94a3b8)', color:'#334155'}}><div style={{fontSize:'3rem'}}>ðŸ¤´</div><div>HEADS</div></div>
                                        <div style={{position:'absolute', width:'100%', height:'100%', backfaceVisibility:'hidden', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', borderRadius:'50%', border:'8px solid #f59e0b', background:'radial-gradient(circle, #fef3c7, #d97706)', color:'#78350f', transform:'rotateY(180deg)'}}><div style={{fontSize:'3rem'}}>ðŸ¦…</div><div>TAILS</div></div>
                                    </div>
                                    <style>{`@keyframes flipHeads { 0% { transform: rotateY(0); } 100% { transform: rotateY(1800deg); } } @keyframes flipTails { 0% { transform: rotateY(0); } 100% { transform: rotateY(1980deg); } }`}</style>
                                </div>
                            )}
                            {chanceAnim === 'dice' && (
                                <div style={{perspective: 1000, width: 100, height: 100, margin: '20px auto'}}>
                                    <div style={{width:'100%', height:'100%', transformStyle:'preserve-3d', animation: `roll${chanceResult} 2s cubic-bezier(0.1, 0.8, 0.2, 1) forwards`}}>
                                        {[1,2,3,4,5,6].map(n => {
                                            let t = ''; if(n===1) t='translateZ(50px)'; if(n===2) t='rotateX(-90deg) translateZ(50px)'; if(n===3) t='rotateY(-90deg) translateZ(50px)'; if(n===4) t='rotateY(90deg) translateZ(50px)'; if(n===5) t='rotateX(90deg) translateZ(50px)'; if(n===6) t='rotateY(180deg) translateZ(50px)';
                                            return <div key={n} style={{position:'absolute', width:100, height:100, background:'white', border:'2px solid #ccc', borderRadius:16, display:'flex', alignItems:'center', justifyContent:'center', fontSize:40, fontWeight:'bold', color:'#333', backfaceVisibility:'hidden', transform: t}}>{n}</div>
                                        })}
                                    </div>
                                    <style>{`@keyframes roll1 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(720deg); } } @keyframes roll2 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(810deg) rotateY(720deg); } } @keyframes roll3 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(810deg); } } @keyframes roll4 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(630deg); } } @keyframes roll5 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(630deg) rotateY(720deg); } } @keyframes roll6 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(900deg); } }`}</style>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                
                {winner && !battleMode && (
                    <div className="modal-overlay">
                        <div className="modal">
                            <div style={{width: 80, height: 80, background: '#fbbf24', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px auto', boxShadow: '0 0 30px rgba(251, 191, 36, 0.4)'}}><div style={{color:'#78350f'}}><Icons.Trophy/></div></div>
                            <h2 style={{margin:0, opacity: 0.6}}>The winner is</h2>
                            {rapidMode ? (
                                <div style={{margin:'20px 0', maxHeight:'300px', overflowY:'auto'}}>
                                    {rapidWinners.map((n,i) => <div key={i} style={{fontSize:'1.5rem', fontWeight:700, borderBottom:'1px solid rgba(128,128,128,0.2)', padding:'8px'}}>{i+1}. {n}</div>)}
                                    {rapidWinners.length < rapidTarget && <div style={{opacity:0.5, fontStyle:'italic', marginTop:10}}>Picking next...</div>}
                                </div>
                            ) : (
                                <>
                                    <div className="winner-name">{winner}</div>
                                    {bloomMode === 'dual' && bloomWinner && (<div style={{background: 'rgba(59, 130, 246, 0.15)', color: '#60a5fa', padding: '10px', borderRadius: 8, marginTop: -10, marginBottom: 20, fontWeight: 700}}><div style={{fontSize: '0.8rem', opacity: 0.8, textTransform:'uppercase', letterSpacing:1}}>Challenge</div><div style={{fontSize: '1.5rem'}}>{bloomWinner}</div></div>)}
                                    {winnerTimerActive && <WinnerTimer duration={30} onComplete={() => playSound('bell', audioCtxRef)} />}
                                    {!winnerTimerActive && (<button onClick={() => setWinnerTimerActive(true)} className="btn" style={{margin:'0 auto', background:'rgba(255,255,255,0.1)', fontSize:'0.9rem'}}>Start 30s Timer</button>)}
                                </>
                            )}
                            <div style={{display: 'flex', flexDirection: 'column', gap: 12, marginTop: 20}}>
                                {(chanceAnim || tempWheelItems) ? (
                                    <button onClick={removeWinner} className="btn" style={{justifyContent: 'center', background: 'rgba(255,255,255,0.1)', padding: 12}}>Close</button>
                                ) : (
                                    <>
                                        <button onClick={() => setWinner(null)} className="btn" style={{justifyContent: 'center', background: 'rgba(128,128,128,0.2)', padding: 12}}>Keep Name</button>
                                        <button onClick={removeWinner} className="btn" style={{justifyContent: 'center', background: 'rgba(239, 68, 68, 0.15)', color: '#ef4444', padding: 12}}><Icons.UserMinus/> Remove & Close</button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                {showImport && <ImportModal onClose={() => setShowImport(false)} onImport={performImport} />}
                {showGroups && <GroupMakerModal names={activeNames} onClose={() => setShowGroups(false)} onStartScoring={handleStartScoring} />}
                {showConceptEdit && <ConceptModal concepts={concepts} onClose={() => setShowConceptEdit(false)} onSave={setConcepts} />}
                {showLineup && (
                    <div className="modal-overlay">
                        <div className="modal" style={{maxWidth: 500, textAlign:'left', maxHeight:'80vh', display:'flex', flexDirection:'column'}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:20, alignItems:'center'}}>
                                <h2 style={{margin:0, fontSize:'1.5rem'}}>Presentation Order</h2>
                                <button onClick={() => setShowLineup(false)} className="btn" style={{padding:4}}><Icons.X/></button>
                            </div>
                            <div style={{overflowY:'auto', flex:1, paddingRight:10, background:'rgba(0,0,0,0.2)', borderRadius:12, padding:10, opacity: isLineupAnimating ? 0.8 : 1, transform: isLineupAnimating ? 'scale(0.99)' : 'scale(1)', transition: 'all 0.1s'}}>
                                {lineupList.map((name, i) => (
                                    <div key={i} style={{display:'flex', alignItems:'center', gap:15, padding:'12px', background: i%2===0?'rgba(255,255,255,0.05)':'transparent', borderRadius:8, borderBottom:'1px solid rgba(255,255,255,0.05)', animation: isLineupAnimating ? 'none' : `fadeIn 0.3s ease-out forwards ${i * 0.05}s`, opacity: isLineupAnimating ? 1 : 0}}>
                                        <div style={{fontWeight:800, fontSize:'1.2rem', color: theme.accent, width: 30, textAlign:'center'}}>{i+1}</div>
                                        <div style={{fontSize:'1.1rem', fontWeight:600}}>{name}</div>
                                    </div>
                                ))}
                            </div>
                            <div style={{marginTop:20, display:'flex', gap:10}}>
                                <button onClick={generateLineup} disabled={isLineupAnimating} className="btn" style={{flex:1, justifyContent:'center', background:'rgba(255,255,255,0.1)', opacity: isLineupAnimating ? 0.5 : 1}}><Icons.Shuffle/> {isLineupAnimating ? "Shuffling..." : "Reshuffle"}</button>
                                <button onClick={() => {navigator.clipboard.writeText(lineupList.map((n,i)=>`${i+1}. ${n}`).join('\\n')); alert("List copied to clipboard!");}} className="btn" style={{flex:1, justifyContent:'center', background: theme.accent, color:'white'}}><Icons.Copy/> Copy List</button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>